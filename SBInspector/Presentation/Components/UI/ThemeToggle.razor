@inject ThemeService ThemeService
@inject IJSRuntime JSRuntime
@implements IDisposable

<button class="btn btn-outline-secondary btn-sm theme-toggle" @onclick="ToggleTheme" title="@GetThemeTooltip()">
    @if (ThemeService.IsDarkMode)
    {
        <i class="bi bi-sun-fill"></i>
    }
    else
    {
        <i class="bi bi-moon-fill"></i>
    }
</button>

@code {
    private bool _themeChanged;

    protected override void OnInitialized()
    {
        ThemeService.OnThemeChanged += StateHasChanged;
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (_themeChanged)
        {
            _themeChanged = false;
            var isDarkMode = ThemeService.IsDarkMode;
            
            try
            {
                var script = isDarkMode 
                    ? "document.body.classList.remove('light-theme'); document.body.classList.add('dark-theme');"
                    : "document.body.classList.remove('dark-theme'); document.body.classList.add('light-theme');";
                
                await JSRuntime.InvokeVoidAsync("eval", script);
            }
            catch (Exception ex)
            {
                Console.WriteLine($"Error toggling theme: {ex.Message}");
            }
        }
    }

    private void ToggleTheme()
    {
        ThemeService.ToggleTheme();
        _themeChanged = true;
    }

    private string GetThemeTooltip()
    {
        return ThemeService.IsDarkMode ? "Switch to Light Mode" : "Switch to Dark Mode";
    }

    public void Dispose()
    {
        ThemeService.OnThemeChanged -= StateHasChanged;
    }
}
