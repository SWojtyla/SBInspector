@using SBInspector.Core.Domain
@using SBInspector.Application.Services
@inject StorageConfigurationService ConfigService

<div class="card">
    <div class="card-body">
        <h5 class="card-title">
            <i class="bi bi-gear"></i> Storage Settings
        </h5>
        
        <div class="mb-3">
            <label class="form-label">Storage Location</label>
            <select class="form-select" @bind="selectedStorageType" @bind:after="OnStorageTypeChanged">
                <option value="@StorageType.LocalStorage">Browser Local Storage (Web)</option>
                <option value="@StorageType.FileSystem">File System (Desktop - Recommended for Tauri)</option>
            </select>
            <small class="form-text text-muted">
                @if (selectedStorageType == StorageType.LocalStorage)
                {
                    <text>Data is stored in browser localStorage. Best for web deployments.</text>
                }
                else
                {
                    <text>Data is saved to files on your Desktop in 'SBInspector' folder. Best for Tauri desktop app.</text>
                }
            </small>
        </div>

        @if (!string.IsNullOrEmpty(successMessage))
        {
            <div class="alert alert-success alert-dismissible fade show" role="alert">
                <i class="bi bi-check-circle"></i> @successMessage
                <button type="button" class="btn-close" @onclick="() => successMessage = string.Empty"></button>
            </div>
        }

        @if (!string.IsNullOrEmpty(infoMessage))
        {
            <div class="alert alert-info" role="alert">
                <i class="bi bi-info-circle"></i> @infoMessage
            </div>
        }
    </div>
</div>

@code {
    private StorageType selectedStorageType;
    private string successMessage = string.Empty;
    private string infoMessage = string.Empty;

    protected override void OnInitialized()
    {
        var config = ConfigService.GetConfiguration();
        selectedStorageType = config.StorageType;
    }

    private async Task OnStorageTypeChanged()
    {
        try
        {
            await ConfigService.SetStorageTypeAsync(selectedStorageType);
            successMessage = "Storage type updated successfully!";
            infoMessage = "Please restart the application for changes to take full effect.";
        }
        catch (Exception ex)
        {
            successMessage = string.Empty;
            infoMessage = $"Error updating storage type: {ex.Message}";
        }
    }
}
