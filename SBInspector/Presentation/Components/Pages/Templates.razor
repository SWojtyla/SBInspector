@page "/templates"
@using SBInspector.Core.Interfaces
@using SBInspector.Core.Domain
@inject IStorageService StorageService

<PageTitle>Message Templates - SBInspector</PageTitle>

<div class="container-fluid mt-4">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h1>
            <i class="bi bi-file-earmark-text"></i> Message Templates
        </h1>
        <button class="btn btn-primary" @onclick="ShowCreateModal">
            <i class="bi bi-plus-circle"></i> New Template
        </button>
    </div>

    @if (isLoading)
    {
        <div class="text-center py-5">
            <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">Loading...</span>
            </div>
            <p class="mt-2">Loading templates...</p>
        </div>
    }
    else if (!templates.Any())
    {
        <div class="alert alert-info">
            <i class="bi bi-info-circle"></i> No message templates found. Create your first template to get started!
        </div>
    }
    else
    {
        <div class="card">
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-hover">
                        <thead>
                            <tr>
                                <th>Name</th>
                                <th>Subject</th>
                                <th>Content Type</th>
                                <th>Created</th>
                                <th>Last Used</th>
                                <th style="width: 200px;">Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            @foreach (var template in templates.OrderByDescending(t => t.LastUsedAt).ThenByDescending(t => t.CreatedAt))
                            {
                                <tr>
                                    <td>
                                        <strong>@template.Name</strong>
                                    </td>
                                    <td>@(template.Subject ?? "-")</td>
                                    <td>@(template.ContentType ?? "text/plain")</td>
                                    <td>@template.CreatedAt.ToLocalTime().ToString("g")</td>
                                    <td>@(template.LastUsedAt?.ToLocalTime().ToString("g") ?? "Never")</td>
                                    <td>
                                        <div class="btn-group btn-group-sm" role="group">
                                            <button class="btn btn-outline-primary" @onclick="() => ShowViewModal(template)" title="View">
                                                <i class="bi bi-eye"></i>
                                            </button>
                                            <button class="btn btn-outline-secondary" @onclick="() => ShowEditModal(template)" title="Edit">
                                                <i class="bi bi-pencil"></i>
                                            </button>
                                            <button class="btn btn-outline-danger" @onclick="() => ShowDeleteConfirmation(template)" title="Delete">
                                                <i class="bi bi-trash"></i>
                                            </button>
                                        </div>
                                    </td>
                                </tr>
                            }
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <div class="mt-3">
            <small class="text-muted">Total templates: @templates.Count</small>
        </div>
    }

    @if (!string.IsNullOrEmpty(successMessage))
    {
        <div class="alert alert-success alert-dismissible fade show mt-3">
            <i class="bi bi-check-circle"></i> @successMessage
            <button type="button" class="btn-close" @onclick="() => successMessage = string.Empty"></button>
        </div>
    }

    @if (!string.IsNullOrEmpty(errorMessage))
    {
        <div class="alert alert-danger alert-dismissible fade show mt-3">
            <i class="bi bi-exclamation-triangle"></i> @errorMessage
            <button type="button" class="btn-close" @onclick="() => errorMessage = string.Empty"></button>
        </div>
    }
</div>

<MessageTemplateEditorModal
    IsVisible="@isEditorVisible"
    IsEditMode="@isEditMode"
    Template="@selectedTemplate"
    OnClose="@HandleEditorClose"
    OnSave="@HandleTemplateSave" />

<ConfirmationModal
    IsVisible="@isDeleteConfirmVisible"
    Title="Delete Template"
    Message="@deleteConfirmMessage"
    OnConfirm="@HandleDeleteConfirm"
    OnCancel="@HandleDeleteCancel" />

@if (isViewModalVisible && selectedTemplate != null)
{
    <div class="modal show d-block" tabindex="-1" style="background-color: rgba(0,0,0,0.5);">
        <div class="modal-dialog modal-lg modal-dialog-scrollable">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">
                        <i class="bi bi-eye"></i> View Template: @selectedTemplate.Name
                    </h5>
                    <button type="button" class="btn-close" @onclick="CloseViewModal"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label class="form-label fw-bold">Template Name</label>
                        <p class="form-control-plaintext">@selectedTemplate.Name</p>
                    </div>

                    <div class="mb-3">
                        <label class="form-label fw-bold">Message Body</label>
                        <pre class="bg-light p-3 rounded" style="max-height: 300px; overflow-y: auto;">@selectedTemplate.MessageBody</pre>
                    </div>

                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label class="form-label fw-bold">Subject</label>
                            <p class="form-control-plaintext">@(selectedTemplate.Subject ?? "-")</p>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label fw-bold">Content Type</label>
                            <p class="form-control-plaintext">@(selectedTemplate.ContentType ?? "text/plain")</p>
                        </div>
                    </div>

                    @if (selectedTemplate.Properties?.Any() == true)
                    {
                        <div class="mb-3">
                            <label class="form-label fw-bold">Application Properties</label>
                            <div class="bg-light p-3 rounded">
                                @foreach (var prop in selectedTemplate.Properties)
                                {
                                    <div class="mb-1">
                                        <code>@prop.Key</code> = <code>@prop.Value</code>
                                    </div>
                                }
                            </div>
                        </div>
                    }

                    <div class="row">
                        <div class="col-md-6">
                            <label class="form-label fw-bold">Created</label>
                            <p class="form-control-plaintext">@selectedTemplate.CreatedAt.ToLocalTime().ToString("g")</p>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label fw-bold">Last Used</label>
                            <p class="form-control-plaintext">@(selectedTemplate.LastUsedAt?.ToLocalTime().ToString("g") ?? "Never")</p>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" @onclick="CloseViewModal">
                        <i class="bi bi-x-lg"></i> Close
                    </button>
                    <button type="button" class="btn btn-primary" @onclick="() => { CloseViewModal(); ShowEditModal(selectedTemplate); }">
                        <i class="bi bi-pencil"></i> Edit
                    </button>
                </div>
            </div>
        </div>
    </div>
}

@code {
    private List<MessageTemplate> templates = new();
    private bool isLoading = false;
    private string errorMessage = string.Empty;
    private string successMessage = string.Empty;

    // Editor modal
    private bool isEditorVisible = false;
    private bool isEditMode = false;
    private MessageTemplate? selectedTemplate = null;

    // Delete confirmation
    private bool isDeleteConfirmVisible = false;
    private MessageTemplate? templateToDelete = null;
    private string deleteConfirmMessage = string.Empty;

    // View modal
    private bool isViewModalVisible = false;

    protected override async Task OnInitializedAsync()
    {
        await LoadTemplatesAsync();
    }

    private async Task LoadTemplatesAsync()
    {
        isLoading = true;
        errorMessage = string.Empty;

        try
        {
            templates = await StorageService.GetMessageTemplatesAsync();
        }
        catch (Exception ex)
        {
            errorMessage = $"Error loading templates: {ex.Message}";
        }
        finally
        {
            isLoading = false;
        }
    }

    private void ShowCreateModal()
    {
        selectedTemplate = null;
        isEditMode = false;
        isEditorVisible = true;
    }

    private void ShowEditModal(MessageTemplate template)
    {
        selectedTemplate = template;
        isEditMode = true;
        isEditorVisible = true;
    }

    private void ShowViewModal(MessageTemplate template)
    {
        selectedTemplate = template;
        isViewModalVisible = true;
    }

    private void CloseViewModal()
    {
        isViewModalVisible = false;
        selectedTemplate = null;
    }

    private void ShowDeleteConfirmation(MessageTemplate template)
    {
        templateToDelete = template;
        deleteConfirmMessage = $"Are you sure you want to delete the template '{template.Name}'? This action cannot be undone.";
        isDeleteConfirmVisible = true;
    }

    private Task HandleEditorClose()
    {
        isEditorVisible = false;
        selectedTemplate = null;
        return Task.CompletedTask;
    }

    private async Task HandleTemplateSave(MessageTemplate template)
    {
        try
        {
            await StorageService.SaveMessageTemplateAsync(template);
            await LoadTemplatesAsync();
            isEditorVisible = false;
            selectedTemplate = null;
            successMessage = isEditMode ? "Template updated successfully!" : "Template created successfully!";
        }
        catch (Exception ex)
        {
            errorMessage = $"Error saving template: {ex.Message}";
        }
    }

    private async Task HandleDeleteConfirm()
    {
        if (templateToDelete != null)
        {
            try
            {
                await StorageService.DeleteMessageTemplateAsync(templateToDelete.Id);
                await LoadTemplatesAsync();
                successMessage = $"Template '{templateToDelete.Name}' deleted successfully!";
            }
            catch (Exception ex)
            {
                errorMessage = $"Error deleting template: {ex.Message}";
            }
            finally
            {
                templateToDelete = null;
                isDeleteConfirmVisible = false;
            }
        }
    }

    private void HandleDeleteCancel()
    {
        templateToDelete = null;
        isDeleteConfirmVisible = false;
    }
}
