@page "/"
@using SBInspector.Core.Interfaces
@using SBInspector.Core.Domain
@inject IServiceBusService ServiceBusService
@rendermode InteractiveServer

<PageTitle>Service Bus Inspector</PageTitle>

<div class="container-fluid mt-4">
    <h1 class="mb-4">Azure Service Bus Inspector</h1>

    @if (!ServiceBusService.IsConnected)
    {
        <ConnectionForm 
            @bind-ConnectionString="@connectionString"
            @bind-ErrorMessage="@errorMessage"
            @bind-IsConnecting="@isConnecting"
            OnConnected="@HandleConnected" />
    }
    else
    {
        <div class="mb-3">
            <button class="btn btn-danger" @onclick="Disconnect">Disconnect</button>
        </div>

        <ul class="nav nav-tabs mb-3" id="entityTabs" role="tablist">
            <li class="nav-item" role="presentation">
                <button class="nav-link @(activeTab == "queues" ? "active" : "")" @onclick="() => LoadQueuesAsync()">
                    Queues
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link @(activeTab == "topics" ? "active" : "")" @onclick="() => LoadTopicsAsync()">
                    Topics
                </button>
            </li>
        </ul>

        @if (isLoading)
        {
            <div class="text-center">
                <div class="spinner-border" role="status">
                    <span class="visually-hidden">Loading...</span>
                </div>
            </div>
        }
        else
        {
            @if (activeTab == "queues")
            {
                <QueueListTable 
                    Queues="@queues" 
                    @bind-SortColumn="@queueSortColumn"
                    @bind-SortAscending="@queueSortAscending"
                    OnViewMessages="@HandleViewQueueMessages" />
            }
            else if (activeTab == "topics")
            {
                <TopicListTable 
                    Topics="@topics"
                    OnViewSubscriptions="@ViewTopicSubscriptions" />
            }
        }

        @if (!string.IsNullOrEmpty(selectedEntity))
        {
            <MessagesPanel 
                EntityName="@selectedEntity"
                MessageType="@selectedMessageType"
                Messages="@messages"
                IsLoading="@isLoadingMessages"
                @bind-Filters="@messageFilters"
                @bind-SortColumn="@messageSortColumn"
                @bind-SortAscending="@messageSortAscending"
                @bind-PageSize="@pageSize"
                HasMoreMessages="@hasMoreMessages"
                IsLoadingMore="@isLoadingMoreMessages"
                OnClose="@CloseMessages"
                OnViewMessageDetails="@ViewMessageDetails"
                OnLoadMore="@LoadMoreMessages" />
        }

        <MessageDetailsModal 
            Message="@selectedMessage"
            OnClose="@CloseMessageDetails" />

        @if (!string.IsNullOrEmpty(selectedTopic))
        {
            <SubscriptionListPanel 
                TopicName="@selectedTopic"
                Subscriptions="@subscriptions"
                IsLoading="@isLoadingSubscriptions"
                OnClose="@CloseSubscriptions"
                OnViewMessages="@HandleViewSubscriptionMessages" />
        }
    }
</div>

@code {
    private string connectionString = string.Empty;
    private string errorMessage = string.Empty;
    private bool isConnecting = false;
    private bool isLoading = false;
    private bool isLoadingMessages = false;
    private bool isLoadingSubscriptions = false;
    private string activeTab = "queues";
    
    private List<EntityInfo> queues = new();
    private List<EntityInfo> topics = new();
    private List<MessageInfo> messages = new();
    private List<string> subscriptions = new();
    
    private string selectedEntity = string.Empty;
    private string selectedMessageType = string.Empty;
    private string selectedTopic = string.Empty;
    private string selectedSubscriptionName = string.Empty;
    private MessageInfo? selectedMessage = null;
    
    private List<MessageFilter> messageFilters = new() { new MessageFilter() };
    
    // Pagination state
    private int pageSize = 100;
    private bool hasMoreMessages = false;
    private bool isLoadingMoreMessages = false;

    // Sorting state for queues
    private string queueSortColumn = nameof(EntityInfo.Name);
    private bool queueSortAscending = true;

    // Sorting state for messages
    private string messageSortColumn = nameof(MessageInfo.EnqueuedTime);
    private bool messageSortAscending = false;

    private async Task HandleConnected()
    {
        await LoadQueuesAsync();
    }

    private void Disconnect()
    {
        ServiceBusService.Disconnect();
        queues.Clear();
        topics.Clear();
        messages.Clear();
        subscriptions.Clear();
        selectedEntity = string.Empty;
        selectedTopic = string.Empty;
        activeTab = "queues";
    }

    private async Task LoadQueuesAsync()
    {
        activeTab = "queues";
        isLoading = true;
        selectedEntity = string.Empty;
        selectedTopic = string.Empty;
        
        try
        {
            queues = await ServiceBusService.GetQueuesAsync();
        }
        finally
        {
            isLoading = false;
        }
    }

    private async Task LoadTopicsAsync()
    {
        activeTab = "topics";
        isLoading = true;
        selectedEntity = string.Empty;
        selectedTopic = string.Empty;
        
        try
        {
            topics = await ServiceBusService.GetTopicsAsync();
        }
        finally
        {
            isLoading = false;
        }
    }

    private async Task HandleViewQueueMessages((string QueueName, string MessageType) args)
    {
        selectedEntity = args.QueueName;
        selectedMessageType = args.MessageType;
        selectedTopic = string.Empty;
        selectedSubscriptionName = string.Empty;
        isLoadingMessages = true;
        
        try
        {
            messages = await ServiceBusService.GetMessagesAsync(args.QueueName, args.MessageType, pageSize);
            hasMoreMessages = messages.Count == pageSize;
        }
        finally
        {
            isLoadingMessages = false;
        }
    }

    private void CloseMessages()
    {
        selectedEntity = string.Empty;
        selectedMessageType = string.Empty;
        selectedSubscriptionName = string.Empty;
        messages.Clear();
        messageFilters.Clear();
        messageFilters.Add(new MessageFilter());
        hasMoreMessages = false;
    }

    private void ViewMessageDetails(MessageInfo message)
    {
        selectedMessage = message;
    }

    private void CloseMessageDetails()
    {
        selectedMessage = null;
    }

    private async Task ViewTopicSubscriptions(string topicName)
    {
        selectedTopic = topicName;
        selectedEntity = string.Empty;
        isLoadingSubscriptions = true;
        
        try
        {
            subscriptions = await ServiceBusService.GetSubscriptionsAsync(topicName);
        }
        finally
        {
            isLoadingSubscriptions = false;
        }
    }

    private void CloseSubscriptions()
    {
        selectedTopic = string.Empty;
        subscriptions.Clear();
    }

    private async Task HandleViewSubscriptionMessages((string TopicName, string SubscriptionName, string MessageType) args)
    {
        selectedEntity = $"{args.TopicName}/{args.SubscriptionName}";
        selectedMessageType = args.MessageType;
        selectedSubscriptionName = args.SubscriptionName;
        selectedTopic = args.TopicName;
        isLoadingMessages = true;
        
        try
        {
            messages = await ServiceBusService.GetSubscriptionMessagesAsync(args.TopicName, args.SubscriptionName, args.MessageType, pageSize);
            hasMoreMessages = messages.Count == pageSize;
        }
        finally
        {
            isLoadingMessages = false;
        }
    }
    
    private async Task LoadMoreMessages()
    {
        if (!hasMoreMessages || isLoadingMoreMessages || messages.Count == 0) return;
        
        isLoadingMoreMessages = true;
        
        try
        {
            // Get the last message's sequence number to continue from the next one
            var lastSequenceNumber = messages.Max(m => m.SequenceNumber) + 1;
            
            List<MessageInfo> newMessages;
            
            // Determine if we're loading from a queue or subscription
            if (!string.IsNullOrEmpty(selectedSubscriptionName))
            {
                // It's a subscription
                newMessages = await ServiceBusService.GetSubscriptionMessagesAsync(
                    selectedTopic, 
                    selectedSubscriptionName, 
                    selectedMessageType, 
                    pageSize, 
                    lastSequenceNumber);
            }
            else
            {
                // It's a queue
                newMessages = await ServiceBusService.GetMessagesAsync(
                    selectedEntity, 
                    selectedMessageType, 
                    pageSize, 
                    lastSequenceNumber);
            }
            
            if (newMessages.Count > 0)
            {
                messages.AddRange(newMessages);
                hasMoreMessages = newMessages.Count == pageSize;
            }
            else
            {
                hasMoreMessages = false;
            }
        }
        finally
        {
            isLoadingMoreMessages = false;
        }
    }
}
