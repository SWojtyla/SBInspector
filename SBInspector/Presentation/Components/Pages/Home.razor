@page "/"
@using SBInspector.Core.Interfaces
@using SBInspector.Core.Domain
@inject IServiceBusService ServiceBusService
@rendermode InteractiveServer

<PageTitle>Service Bus Inspector</PageTitle>

<div class="container-fluid mt-4">
    <h1 class="mb-4">Azure Service Bus Inspector</h1>

    @if (!ServiceBusService.IsConnected)
    {
        <ConnectionForm 
            @bind-ConnectionString="@connectionString"
            @bind-ErrorMessage="@errorMessage"
            @bind-IsConnecting="@isConnecting"
            OnConnected="@HandleConnected" />
    }
    else
    {
        <div class="mb-3">
            <button class="btn btn-danger" @onclick="Disconnect">Disconnect</button>
        </div>

        <ul class="nav nav-tabs mb-3" id="entityTabs" role="tablist">
            <li class="nav-item" role="presentation">
                <button class="nav-link @(activeTab == "queues" ? "active" : "")" @onclick="() => LoadQueuesAsync()">
                    Queues
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link @(activeTab == "topics" ? "active" : "")" @onclick="() => LoadTopicsAsync()">
                    Topics
                </button>
            </li>
        </ul>

        @if (isLoading)
        {
            <div class="text-center">
                <div class="spinner-border" role="status">
                    <span class="visually-hidden">Loading...</span>
                </div>
            </div>
        }
        else
        {
            @if (activeTab == "queues")
            {
                <QueueListTable 
                    Queues="@queues" 
                    @bind-SortColumn="@queueSortColumn"
                    @bind-SortAscending="@queueSortAscending"
                    OnViewMessages="@HandleViewQueueMessages" />
            }
            else if (activeTab == "topics")
            {
                <TopicListTable 
                    Topics="@topics"
                    OnViewSubscriptions="@ViewTopicSubscriptions" />
            }
        }

        @if (!string.IsNullOrEmpty(selectedEntity))
        {
            <MessagesPanel 
                EntityName="@selectedEntity"
                MessageType="@selectedMessageType"
                Messages="@messages"
                IsLoading="@isLoadingMessages"
                @bind-Filters="@messageFilters"
                @bind-SortColumn="@messageSortColumn"
                @bind-SortAscending="@messageSortAscending"
                @bind-PageSize="@pageSize"
                HasMoreMessages="@hasMoreMessages"
                IsLoadingMore="@isLoadingMoreMessages"
                OnClose="@CloseMessages"
                OnViewMessageDetails="@ViewMessageDetails"
                OnDeleteMessage="@HandleDeleteMessage"
                OnRequeueMessage="@HandleRequeueMessage"
                OnRescheduleMessage="@HandleRescheduleMessage"
                OnSendNew="@HandleSendNewMessage"
                OnPurge="@HandlePurgeMessages"
                OnLoadMore="@LoadMoreMessages" />
        }

        <MessageDetailsModal 
            Message="@selectedMessage"
            OnClose="@CloseMessageDetails" />

        <ConfirmationModal 
            IsVisible="@showDeleteConfirmation"
            Title="Delete Message"
            Message="@deleteConfirmationMessage"
            IconClass="bi-exclamation-triangle"
            ConfirmIconClass="bi-trash"
            ConfirmButtonClass="btn-danger"
            ConfirmText="Delete"
            OnConfirm="@ConfirmDelete"
            OnCancel="@CancelDelete" />

        <ConfirmationModal 
            IsVisible="@showRequeueConfirmation"
            Title="Requeue Message"
            Message="Are you sure you want to requeue this message from the dead-letter queue to the active queue?"
            IconClass="bi-arrow-counterclockwise"
            ConfirmIconClass="bi-check-lg"
            ConfirmButtonClass="btn-success"
            ConfirmText="Requeue"
            OnConfirm="@ConfirmRequeue"
            OnCancel="@CancelRequeue" />

        <ConfirmationModal 
            IsVisible="@showPurgeConfirmation"
            Title="Purge All Messages"
            Message="@purgeConfirmationMessage"
            IconClass="bi-exclamation-triangle-fill"
            ConfirmIconClass="bi-trash-fill"
            ConfirmButtonClass="btn-danger"
            ConfirmText="Purge All"
            OnConfirm="@ConfirmPurge"
            OnCancel="@CancelPurge" />

        <SendMessageModal
            IsVisible="@showSendModal"
            Title="@sendModalTitle"
            IsReschedule="@isRescheduleMode"
            OnClose="@CloseSendModal"
            OnSend="@HandleSendMessage" />

        @if (!string.IsNullOrEmpty(successMessage))
        {
            <div class="alert alert-success alert-dismissible fade show position-fixed top-0 start-50 translate-middle-x mt-3" style="z-index: 9999; min-width: 300px;" role="alert">
                <i class="bi bi-check-circle"></i> @successMessage
                <button type="button" class="btn-close" @onclick="() => successMessage = string.Empty"></button>
            </div>
        }

        @if (!string.IsNullOrEmpty(operationErrorMessage))
        {
            <div class="alert alert-danger alert-dismissible fade show position-fixed top-0 start-50 translate-middle-x mt-3" style="z-index: 9999; min-width: 300px;" role="alert">
                <i class="bi bi-exclamation-triangle"></i> @operationErrorMessage
                <button type="button" class="btn-close" @onclick="() => operationErrorMessage = string.Empty"></button>
            </div>
        }

        @if (!string.IsNullOrEmpty(selectedTopic))
        {
            <SubscriptionListPanel 
                TopicName="@selectedTopic"
                Subscriptions="@subscriptions"
                IsLoading="@isLoadingSubscriptions"
                OnClose="@CloseSubscriptions"
                OnViewMessages="@HandleViewSubscriptionMessages" />
        }
    }
</div>

@code {
    private string connectionString = string.Empty;
    private string errorMessage = string.Empty;
    private bool isConnecting = false;
    private bool isLoading = false;
    private bool isLoadingMessages = false;
    private bool isLoadingSubscriptions = false;
    private string activeTab = "queues";
    
    private List<EntityInfo> queues = new();
    private List<EntityInfo> topics = new();
    private List<MessageInfo> messages = new();
    private List<SubscriptionInfo> subscriptions = new();
    
    private string selectedEntity = string.Empty;
    private string selectedMessageType = string.Empty;
    private string selectedTopic = string.Empty;
    private string selectedSubscriptionName = string.Empty;
    private MessageInfo? selectedMessage = null;
    
    private List<MessageFilter> messageFilters = new() { new MessageFilter() };
    
    // Pagination state
    private int pageSize = 100;
    private bool hasMoreMessages = false;
    private bool isLoadingMoreMessages = false;

    // Sorting state for queues
    private string queueSortColumn = nameof(EntityInfo.Name);
    private bool queueSortAscending = true;

    // Sorting state for messages
    private string messageSortColumn = nameof(MessageInfo.EnqueuedTime);
    private bool messageSortAscending = false;

    private async Task HandleConnected()
    {
        await LoadQueuesAsync();
    }

    private void Disconnect()
    {
        ServiceBusService.Disconnect();
        queues.Clear();
        topics.Clear();
        messages.Clear();
        subscriptions.Clear();
        selectedEntity = string.Empty;
        selectedTopic = string.Empty;
        activeTab = "queues";
    }

    private async Task LoadQueuesAsync()
    {
        activeTab = "queues";
        isLoading = true;
        selectedEntity = string.Empty;
        selectedTopic = string.Empty;
        
        try
        {
            queues = await ServiceBusService.GetQueuesAsync();
        }
        finally
        {
            isLoading = false;
        }
    }

    private async Task LoadTopicsAsync()
    {
        activeTab = "topics";
        isLoading = true;
        selectedEntity = string.Empty;
        selectedTopic = string.Empty;
        
        try
        {
            topics = await ServiceBusService.GetTopicsAsync();
        }
        finally
        {
            isLoading = false;
        }
    }

    private async Task HandleViewQueueMessages((string QueueName, string MessageType) args)
    {
        selectedEntity = args.QueueName;
        selectedMessageType = args.MessageType;
        selectedTopic = string.Empty;
        selectedSubscriptionName = string.Empty;
        isLoadingMessages = true;
        
        try
        {
            messages = await ServiceBusService.GetMessagesAsync(args.QueueName, args.MessageType, pageSize);
            hasMoreMessages = messages.Count == pageSize;
        }
        finally
        {
            isLoadingMessages = false;
        }
    }

    private void CloseMessages()
    {
        selectedEntity = string.Empty;
        selectedMessageType = string.Empty;
        selectedSubscriptionName = string.Empty;
        messages.Clear();
        messageFilters.Clear();
        messageFilters.Add(new MessageFilter());
        hasMoreMessages = false;
    }

    private void ViewMessageDetails(MessageInfo message)
    {
        selectedMessage = message;
    }

    private void CloseMessageDetails()
    {
        selectedMessage = null;
    }

    private async Task ViewTopicSubscriptions(string topicName)
    {
        selectedTopic = topicName;
        selectedEntity = string.Empty;
        isLoadingSubscriptions = true;
        
        try
        {
            subscriptions = await ServiceBusService.GetSubscriptionsAsync(topicName);
        }
        finally
        {
            isLoadingSubscriptions = false;
        }
    }

    private void CloseSubscriptions()
    {
        selectedTopic = string.Empty;
        subscriptions.Clear();
    }

    private async Task HandleViewSubscriptionMessages((string TopicName, string SubscriptionName, string MessageType) args)
    {
        selectedEntity = $"{args.TopicName}/{args.SubscriptionName}";
        selectedMessageType = args.MessageType;
        selectedSubscriptionName = args.SubscriptionName;
        selectedTopic = args.TopicName;
        isLoadingMessages = true;
        
        try
        {
            messages = await ServiceBusService.GetSubscriptionMessagesAsync(args.TopicName, args.SubscriptionName, args.MessageType, pageSize);
            hasMoreMessages = messages.Count == pageSize;
        }
        finally
        {
            isLoadingMessages = false;
        }
    }
    
    private async Task LoadMoreMessages()
    {
        if (!hasMoreMessages || isLoadingMoreMessages || messages.Count == 0) return;
        
        isLoadingMoreMessages = true;
        
        try
        {
            // Get the last message's sequence number to continue from the next one
            var lastSequenceNumber = messages.Max(m => m.SequenceNumber) + 1;
            
            List<MessageInfo> newMessages;
            
            // Determine if we're loading from a queue or subscription
            if (!string.IsNullOrEmpty(selectedSubscriptionName))
            {
                // It's a subscription
                newMessages = await ServiceBusService.GetSubscriptionMessagesAsync(
                    selectedTopic, 
                    selectedSubscriptionName, 
                    selectedMessageType, 
                    pageSize, 
                    lastSequenceNumber);
            }
            else
            {
                // It's a queue
                newMessages = await ServiceBusService.GetMessagesAsync(
                    selectedEntity, 
                    selectedMessageType, 
                    pageSize, 
                    lastSequenceNumber);
            }
            
            if (newMessages.Count > 0)
            {
                messages.AddRange(newMessages);
                hasMoreMessages = newMessages.Count == pageSize;
            }
            else
            {
                hasMoreMessages = false;
            }
        }
        finally
        {
            isLoadingMoreMessages = false;
        }
    }

    // CRUD operation state
    private bool showDeleteConfirmation = false;
    private bool showRequeueConfirmation = false;
    private bool showPurgeConfirmation = false;
    private bool showSendModal = false;
    private bool isRescheduleMode = false;
    private string sendModalTitle = "Send Message";
    private MessageInfo? messageForOperation = null;
    private string deleteConfirmationMessage = string.Empty;
    private string purgeConfirmationMessage = string.Empty;
    private string successMessage = string.Empty;
    private string operationErrorMessage = string.Empty;

    private void HandleDeleteMessage(MessageInfo message)
    {
        messageForOperation = message;
        deleteConfirmationMessage = $"Are you sure you want to delete message '{message.MessageId}'? This action cannot be undone.";
        showDeleteConfirmation = true;
    }

    private async Task ConfirmDelete()
    {
        showDeleteConfirmation = false;
        operationErrorMessage = string.Empty;
        successMessage = string.Empty;

        if (messageForOperation == null) return;

        try
        {
            bool success;
            
            if (!string.IsNullOrEmpty(selectedSubscriptionName))
            {
                // It's a subscription
                success = await ServiceBusService.DeleteMessageAsync(
                    selectedEntity, 
                    messageForOperation.SequenceNumber,
                    isSubscription: true,
                    topicName: selectedTopic,
                    subscriptionName: selectedSubscriptionName);
            }
            else
            {
                // It's a queue
                success = await ServiceBusService.DeleteMessageAsync(
                    selectedEntity, 
                    messageForOperation.SequenceNumber);
            }

            if (success)
            {
                messages.Remove(messageForOperation);
                successMessage = "Message deleted successfully.";
                await Task.Delay(3000);
                successMessage = string.Empty;
            }
            else
            {
                operationErrorMessage = "Failed to delete message. It may have already been processed.";
                await Task.Delay(5000);
                operationErrorMessage = string.Empty;
            }
        }
        catch (Exception ex)
        {
            operationErrorMessage = $"Error deleting message: {ex.Message}";
            await Task.Delay(5000);
            operationErrorMessage = string.Empty;
        }
        finally
        {
            messageForOperation = null;
        }
    }

    private void CancelDelete()
    {
        showDeleteConfirmation = false;
        messageForOperation = null;
    }

    private void HandleRequeueMessage(MessageInfo message)
    {
        messageForOperation = message;
        showRequeueConfirmation = true;
    }

    private async Task ConfirmRequeue()
    {
        showRequeueConfirmation = false;
        operationErrorMessage = string.Empty;
        successMessage = string.Empty;

        if (messageForOperation == null) return;

        try
        {
            bool success;
            
            if (!string.IsNullOrEmpty(selectedSubscriptionName))
            {
                // It's a subscription
                success = await ServiceBusService.RequeueDeadLetterMessageAsync(
                    selectedEntity, 
                    messageForOperation.SequenceNumber,
                    isSubscription: true,
                    topicName: selectedTopic,
                    subscriptionName: selectedSubscriptionName);
            }
            else
            {
                // It's a queue
                success = await ServiceBusService.RequeueDeadLetterMessageAsync(
                    selectedEntity, 
                    messageForOperation.SequenceNumber);
            }

            if (success)
            {
                messages.Remove(messageForOperation);
                successMessage = "Message requeued successfully.";
                await Task.Delay(3000);
                successMessage = string.Empty;
            }
            else
            {
                operationErrorMessage = "Failed to requeue message. It may have already been processed.";
                await Task.Delay(5000);
                operationErrorMessage = string.Empty;
            }
        }
        catch (Exception ex)
        {
            operationErrorMessage = $"Error requeuing message: {ex.Message}";
            await Task.Delay(5000);
            operationErrorMessage = string.Empty;
        }
        finally
        {
            messageForOperation = null;
        }
    }

    private void CancelRequeue()
    {
        showRequeueConfirmation = false;
        messageForOperation = null;
    }

    private void HandleRescheduleMessage(MessageInfo message)
    {
        messageForOperation = message;
        isRescheduleMode = true;
        sendModalTitle = "Reschedule Message";
        showSendModal = true;
    }

    private void HandleSendNewMessage()
    {
        messageForOperation = null;
        isRescheduleMode = false;
        sendModalTitle = "Send New Message";
        showSendModal = true;
    }

    private async Task HandleSendMessage(SendMessageModal.MessageData data)
    {
        showSendModal = false;
        operationErrorMessage = string.Empty;
        successMessage = string.Empty;

        try
        {
            bool success;

            if (isRescheduleMode && messageForOperation != null)
            {
                // Reschedule existing message
                if (!data.ScheduledTime.HasValue)
                {
                    operationErrorMessage = "Scheduled time is required for rescheduling.";
                    return;
                }

                if (!string.IsNullOrEmpty(selectedSubscriptionName))
                {
                    // It's a subscription
                    success = await ServiceBusService.RescheduleMessageAsync(
                        selectedEntity,
                        messageForOperation.SequenceNumber,
                        data.ScheduledTime.Value,
                        isSubscription: true,
                        topicName: selectedTopic,
                        subscriptionName: selectedSubscriptionName);
                }
                else
                {
                    // It's a queue
                    success = await ServiceBusService.RescheduleMessageAsync(
                        selectedEntity,
                        messageForOperation.SequenceNumber,
                        data.ScheduledTime.Value);
                }

                if (success)
                {
                    messages.Remove(messageForOperation);
                    successMessage = $"Message rescheduled for {data.ScheduledTime.Value:yyyy-MM-dd HH:mm:ss}.";
                }
                else
                {
                    operationErrorMessage = "Failed to reschedule message. It may have already been processed.";
                }
            }
            else
            {
                // Send new message
                var entityToSendTo = !string.IsNullOrEmpty(selectedSubscriptionName) ? selectedTopic : selectedEntity;
                
                success = await ServiceBusService.SendMessageAsync(
                    entityToSendTo,
                    data.Body,
                    data.Subject,
                    data.ContentType,
                    data.Properties,
                    data.ScheduledTime);

                if (success)
                {
                    if (data.ScheduledTime.HasValue)
                    {
                        successMessage = $"Message scheduled for {data.ScheduledTime.Value:yyyy-MM-dd HH:mm:ss}.";
                    }
                    else
                    {
                        successMessage = "Message sent successfully.";
                    }
                }
                else
                {
                    operationErrorMessage = "Failed to send message.";
                }
            }

            await Task.Delay(3000);
            successMessage = string.Empty;
            operationErrorMessage = string.Empty;
        }
        catch (Exception ex)
        {
            operationErrorMessage = $"Error: {ex.Message}";
            await Task.Delay(5000);
            operationErrorMessage = string.Empty;
        }
        finally
        {
            messageForOperation = null;
            isRescheduleMode = false;
            sendModalTitle = "Send Message";
        }
    }

    private void CloseSendModal()
    {
        showSendModal = false;
        messageForOperation = null;
        isRescheduleMode = false;
        sendModalTitle = "Send Message";
    }

    private void HandlePurgeMessages()
    {
        var messageTypeDisplay = selectedMessageType switch
        {
            "Active" => "active",
            "Scheduled" => "scheduled",
            "DeadLetter" => "dead-letter",
            _ => selectedMessageType.ToLower()
        };

        purgeConfirmationMessage = $"Are you sure you want to PURGE ALL {messageTypeDisplay} messages from '{selectedEntity}'? " +
            $"This will permanently delete ALL messages and cannot be undone. Type 'PURGE' to confirm.";
        showPurgeConfirmation = true;
    }

    private async Task ConfirmPurge()
    {
        showPurgeConfirmation = false;
        operationErrorMessage = string.Empty;
        successMessage = string.Empty;

        try
        {
            int deletedCount;

            if (!string.IsNullOrEmpty(selectedSubscriptionName))
            {
                // It's a subscription
                deletedCount = await ServiceBusService.PurgeMessagesAsync(
                    selectedEntity,
                    selectedMessageType,
                    isSubscription: true,
                    topicName: selectedTopic,
                    subscriptionName: selectedSubscriptionName);
            }
            else
            {
                // It's a queue
                deletedCount = await ServiceBusService.PurgeMessagesAsync(
                    selectedEntity,
                    selectedMessageType);
            }

            if (deletedCount > 0)
            {
                // Clear the messages list
                messages.Clear();
                hasMoreMessages = false;
                
                successMessage = $"Successfully purged {deletedCount} message(s).";
                await Task.Delay(3000);
                successMessage = string.Empty;
            }
            else
            {
                operationErrorMessage = "No messages were found to purge.";
                await Task.Delay(5000);
                operationErrorMessage = string.Empty;
            }
        }
        catch (Exception ex)
        {
            operationErrorMessage = $"Error purging messages: {ex.Message}";
            await Task.Delay(5000);
            operationErrorMessage = string.Empty;
        }
    }

    private void CancelPurge()
    {
        showPurgeConfirmation = false;
    }
}
