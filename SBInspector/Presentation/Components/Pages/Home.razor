@page "/"
@using SBInspector.Core.Interfaces
@using SBInspector.Core.Domain
@using SBInspector.Application.Services
@inject IServiceBusService ServiceBusService
@inject MessageFilterService FilterService
@rendermode InteractiveServer

<PageTitle>Service Bus Inspector</PageTitle>

<div class="container-fluid mt-4">
    <h1 class="mb-4">Azure Service Bus Inspector</h1>

    @if (!ServiceBusService.IsConnected)
    {
        <ConnectionComponent 
            ConnectionString="@connectionString"
            ConnectionStringChanged="@((value) => connectionString = value)"
            ErrorMessage="@errorMessage"
            IsConnecting="@isConnecting"
            OnConnect="@ConnectAsync" />
    }
    else
    {
        <div class="mb-3">
            <button class="btn btn-danger" @onclick="Disconnect">Disconnect</button>
        </div>

        <ul class="nav nav-tabs mb-3" id="entityTabs" role="tablist">
            <li class="nav-item" role="presentation">
                <button class="nav-link @(activeTab == "queues" ? "active" : "")" @onclick="() => LoadQueuesAsync()">
                    Queues
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link @(activeTab == "topics" ? "active" : "")" @onclick="() => LoadTopicsAsync()">
                    Topics
                </button>
            </li>
        </ul>

        @if (isLoading)
        {
            <div class="text-center">
                <div class="spinner-border" role="status">
                    <span class="visually-hidden">Loading...</span>
                </div>
            </div>
        }
        else
        {
            @if (activeTab == "queues")
            {
                <QueuesListComponent 
                    Queues="@queues" 
                    SortColumn="@queueSortColumn"
                    SortAscending="@queueSortAscending"
                    OnSort="@SortQueues"
                    OnViewMessages="@(args => ViewQueueMessages(args.queueName, args.messageType))" />
            }
            else if (activeTab == "topics")
            {
                <TopicsListComponent 
                    Topics="@topics" 
                    OnViewSubscriptions="@ViewTopicSubscriptions" />
            }
        }

        <MessagesComponent 
            EntityName="@selectedEntity"
            MessageType="@selectedMessageType"
            Messages="@messages"
            Filters="@messageFilters"
            FilteredMessages="@FilteredMessages"
            SortedAndFilteredMessages="@SortedAndFilteredMessages"
            SortColumn="@messageSortColumn"
            SortAscending="@messageSortAscending"
            IsLoading="@isLoadingMessages"
            OnClose="@CloseMessages"
            OnAddFilter="@AddFilter"
            OnRemoveFilter="@RemoveFilter"
            OnClearFilters="@ClearFilters"
            OnSort="@SortMessages"
            OnViewDetails="@ViewMessageDetails" />

        <MessageDetailsModal 
            Message="@selectedMessage" 
            OnClose="@CloseMessageDetails" />

        <SubscriptionsComponent 
            TopicName="@selectedTopic"
            Subscriptions="@subscriptions"
            IsLoading="@isLoadingSubscriptions"
            OnClose="@CloseSubscriptions"
            OnViewMessages="@(args => ViewSubscriptionMessages(selectedTopic, args.subscriptionName, args.messageType))" />
    }
</div>

@code {
    private string connectionString = string.Empty;
    private string errorMessage = string.Empty;
    private bool isConnecting = false;
    private bool isLoading = false;
    private bool isLoadingMessages = false;
    private bool isLoadingSubscriptions = false;
    private string activeTab = "queues";
    
    private List<EntityInfo> queues = new();
    private List<EntityInfo> topics = new();
    private List<MessageInfo> messages = new();
    private List<string> subscriptions = new();
    
    private string selectedEntity = string.Empty;
    private string selectedMessageType = string.Empty;
    private string selectedTopic = string.Empty;
    private MessageInfo? selectedMessage = null;
    
    private List<MessageFilter> messageFilters = new() { new MessageFilter() };

    // Sorting state for queues
    private string queueSortColumn = nameof(EntityInfo.Name);
    private bool queueSortAscending = true;

    // Sorting state for messages
    private string messageSortColumn = nameof(MessageInfo.EnqueuedTime);
    private bool messageSortAscending = false;

    private IEnumerable<MessageInfo> FilteredMessages => FilterService.ApplyFilters(messages, messageFilters);

    private IEnumerable<MessageInfo> SortedAndFilteredMessages
    {
        get
        {
            var filtered = FilteredMessages;
            
            var sorted = messageSortColumn switch
            {
                nameof(MessageInfo.MessageId) => messageSortAscending 
                    ? filtered.OrderBy(m => m.MessageId) 
                    : filtered.OrderByDescending(m => m.MessageId),
                nameof(MessageInfo.Subject) => messageSortAscending 
                    ? filtered.OrderBy(m => m.Subject) 
                    : filtered.OrderByDescending(m => m.Subject),
                nameof(MessageInfo.EnqueuedTime) => messageSortAscending 
                    ? filtered.OrderBy(m => m.EnqueuedTime) 
                    : filtered.OrderByDescending(m => m.EnqueuedTime),
                nameof(MessageInfo.DeliveryCount) => messageSortAscending 
                    ? filtered.OrderBy(m => m.DeliveryCount) 
                    : filtered.OrderByDescending(m => m.DeliveryCount),
                _ => filtered
            };
            
            return sorted;
        }
    }

    private void SortQueues(string columnName)
    {
        if (queueSortColumn == columnName)
        {
            queueSortAscending = !queueSortAscending;
        }
        else
        {
            queueSortColumn = columnName;
            queueSortAscending = true;
        }
    }

    private void SortMessages(string columnName)
    {
        if (messageSortColumn == columnName)
        {
            messageSortAscending = !messageSortAscending;
        }
        else
        {
            messageSortColumn = columnName;
            messageSortAscending = columnName == nameof(MessageInfo.EnqueuedTime) ? false : true;
        }
    }

    private void AddFilter()
    {
        messageFilters.Add(new MessageFilter());
    }

    private void RemoveFilter(int index)
    {
        if (messageFilters.Count > 1)
        {
            messageFilters.RemoveAt(index);
        }
    }

    private async Task ConnectAsync()
    {
        isConnecting = true;
        errorMessage = string.Empty;
        
        try
        {
            var success = await ServiceBusService.ConnectAsync(connectionString);
            if (success)
            {
                await LoadQueuesAsync();
            }
            else
            {
                errorMessage = "Failed to connect. Please check your connection string.";
            }
        }
        catch (Exception ex)
        {
            errorMessage = $"Error: {ex.Message}";
        }
        finally
        {
            isConnecting = false;
        }
    }

    private void Disconnect()
    {
        ServiceBusService.Disconnect();
        queues.Clear();
        topics.Clear();
        messages.Clear();
        subscriptions.Clear();
        selectedEntity = string.Empty;
        selectedTopic = string.Empty;
        activeTab = "queues";
    }

    private async Task LoadQueuesAsync()
    {
        activeTab = "queues";
        isLoading = true;
        selectedEntity = string.Empty;
        selectedTopic = string.Empty;
        
        try
        {
            queues = await ServiceBusService.GetQueuesAsync();
        }
        finally
        {
            isLoading = false;
        }
    }

    private async Task LoadTopicsAsync()
    {
        activeTab = "topics";
        isLoading = true;
        selectedEntity = string.Empty;
        selectedTopic = string.Empty;
        
        try
        {
            topics = await ServiceBusService.GetTopicsAsync();
        }
        finally
        {
            isLoading = false;
        }
    }

    private async Task ViewQueueMessages(string queueName, string messageType)
    {
        selectedEntity = queueName;
        selectedMessageType = messageType;
        selectedTopic = string.Empty;
        isLoadingMessages = true;
        
        try
        {
            messages = await ServiceBusService.GetMessagesAsync(queueName, messageType);
        }
        finally
        {
            isLoadingMessages = false;
        }
    }

    private void CloseMessages()
    {
        selectedEntity = string.Empty;
        selectedMessageType = string.Empty;
        messages.Clear();
        ClearFilters();
    }

    private void ClearFilters()
    {
        messageFilters.Clear();
        messageFilters.Add(new MessageFilter());
    }

    private void ViewMessageDetails(MessageInfo message)
    {
        selectedMessage = message;
    }

    private void CloseMessageDetails()
    {
        selectedMessage = null;
    }

    private async Task ViewTopicSubscriptions(string topicName)
    {
        selectedTopic = topicName;
        selectedEntity = string.Empty;
        isLoadingSubscriptions = true;
        
        try
        {
            subscriptions = await ServiceBusService.GetSubscriptionsAsync(topicName);
        }
        finally
        {
            isLoadingSubscriptions = false;
        }
    }

    private void CloseSubscriptions()
    {
        selectedTopic = string.Empty;
        subscriptions.Clear();
    }

    private async Task ViewSubscriptionMessages(string topicName, string subscriptionName, string messageType)
    {
        selectedEntity = $"{topicName}/{subscriptionName}";
        selectedMessageType = messageType;
        isLoadingMessages = true;
        
        try
        {
            messages = await ServiceBusService.GetSubscriptionMessagesAsync(topicName, subscriptionName, messageType);
        }
        finally
        {
            isLoadingMessages = false;
        }
    }
}
