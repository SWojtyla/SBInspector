@page "/"
@using SBInspector.Services
@using SBInspector.Models
@inject ServiceBusService ServiceBusService
@rendermode InteractiveServer

<PageTitle>Service Bus Inspector</PageTitle>

<div class="container-fluid mt-4">
    <h1 class="mb-4">Azure Service Bus Inspector</h1>

    @if (!ServiceBusService.IsConnected)
    {
        <div class="card">
            <div class="card-body">
                <h5 class="card-title">Connect to Service Bus</h5>
                <div class="mb-3">
                    <label for="connectionString" class="form-label">Connection String</label>
                    <input type="password" class="form-control" id="connectionString" @bind="connectionString" placeholder="Endpoint=sb://..." />
                </div>
                @if (!string.IsNullOrEmpty(errorMessage))
                {
                    <div class="alert alert-danger" role="alert">
                        @errorMessage
                    </div>
                }
                <button class="btn btn-primary" @onclick="ConnectAsync" disabled="@isConnecting">
                    @if (isConnecting)
                    {
                        <span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span>
                        <span> Connecting...</span>
                    }
                    else
                    {
                        <span>Connect</span>
                    }
                </button>
            </div>
        </div>
    }
    else
    {
        <div class="mb-3">
            <button class="btn btn-danger" @onclick="Disconnect">Disconnect</button>
        </div>

        <ul class="nav nav-tabs mb-3" id="entityTabs" role="tablist">
            <li class="nav-item" role="presentation">
                <button class="nav-link @(activeTab == "queues" ? "active" : "")" @onclick="() => LoadQueuesAsync()">
                    Queues
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link @(activeTab == "topics" ? "active" : "")" @onclick="() => LoadTopicsAsync()">
                    Topics
                </button>
            </li>
        </ul>

        @if (isLoading)
        {
            <div class="text-center">
                <div class="spinner-border" role="status">
                    <span class="visually-hidden">Loading...</span>
                </div>
            </div>
        }
        else
        {
            @if (activeTab == "queues")
            {
                <h3>Queues</h3>
                @if (queues.Any())
                {
                    <div class="table-responsive">
                        <table class="table table-striped table-hover">
                            <thead>
                                <tr>
                                    <th>Name</th>
                                    <th>Active Messages</th>
                                    <th>Scheduled Messages</th>
                                    <th>Dead Letter Messages</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                @foreach (var queue in queues)
                                {
                                    <tr>
                                        <td>@queue.Name</td>
                                        <td>@queue.ActiveMessageCount</td>
                                        <td>@queue.ScheduledMessageCount</td>
                                        <td>@queue.DeadLetterMessageCount</td>
                                        <td>
                                            <button class="btn btn-sm btn-primary me-1" @onclick="@(() => ViewQueueMessages(queue.Name, "Active"))">
                                                View Active
                                            </button>
                                            <button class="btn btn-sm btn-warning me-1" @onclick="@(() => ViewQueueMessages(queue.Name, "Scheduled"))">
                                                View Scheduled
                                            </button>
                                            <button class="btn btn-sm btn-danger" @onclick="@(() => ViewQueueMessages(queue.Name, "DeadLetter"))">
                                                View Dead Letter
                                            </button>
                                        </td>
                                    </tr>
                                }
                            </tbody>
                        </table>
                    </div>
                }
                else
                {
                    <p>No queues found.</p>
                }
            }
            else if (activeTab == "topics")
            {
                <h3>Topics</h3>
                @if (topics.Any())
                {
                    <div class="table-responsive">
                        <table class="table table-striped table-hover">
                            <thead>
                                <tr>
                                    <th>Name</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                @foreach (var topic in topics)
                                {
                                    <tr>
                                        <td>@topic.Name</td>
                                        <td>
                                            <button class="btn btn-sm btn-info" @onclick="() => ViewTopicSubscriptions(topic.Name)">
                                                View Subscriptions
                                            </button>
                                        </td>
                                    </tr>
                                }
                            </tbody>
                        </table>
                    </div>
                }
                else
                {
                    <p>No topics found.</p>
                }
            }
        }

        @if (!string.IsNullOrEmpty(selectedEntity))
        {
            <div class="card mt-4">
                <div class="card-header">
                    <h4>@selectedEntity - @selectedMessageType Messages</h4>
                    <button class="btn btn-sm btn-secondary" @onclick="CloseMessages">Close</button>
                </div>
                <div class="card-body">
                    @if (isLoadingMessages)
                    {
                        <div class="text-center">
                            <div class="spinner-border" role="status">
                                <span class="visually-hidden">Loading messages...</span>
                            </div>
                        </div>
                    }
                    else if (messages.Any())
                    {
                        <div class="mb-3">
                            <h5>Filter by Message Attributes</h5>
                            <div class="row g-2">
                                <div class="col-md-4">
                                    <label for="filterAttributeName" class="form-label">Attribute Name</label>
                                    <input type="text" class="form-control" id="filterAttributeName" @bind="filterAttributeName" @bind:event="oninput" placeholder="e.g., customerId" />
                                </div>
                                <div class="col-md-4">
                                    <label for="filterAttributeValue" class="form-label">Attribute Value</label>
                                    <input type="text" class="form-control" id="filterAttributeValue" @bind="filterAttributeValue" @bind:event="oninput" placeholder="e.g., 12345" />
                                </div>
                                <div class="col-md-4">
                                    <div class="form-check mt-4">
                                        <input class="form-check-input" type="checkbox" id="useRegexFilter" @bind="useRegexFilter" />
                                        <label class="form-check-label" for="useRegexFilter">
                                            Use Regex Expression
                                        </label>
                                    </div>
                                    @if (!string.IsNullOrWhiteSpace(filterAttributeName) || !string.IsNullOrWhiteSpace(filterAttributeValue))
                                    {
                                        <button class="btn btn-sm btn-secondary mt-2" @onclick="ClearFilters">Clear Filters</button>
                                    }
                                </div>
                            </div>
                            <div class="mt-2">
                                <small class="text-muted">
                                    Showing @FilteredMessages.Count() of @messages.Count messages
                                </small>
                            </div>
                        </div>
                        <div class="table-responsive">
                            <table class="table table-sm">
                                <thead>
                                    <tr>
                                        <th>Message ID</th>
                                        <th>Subject</th>
                                        <th>Enqueued Time</th>
                                        <th>Delivery Count</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    @foreach (var message in FilteredMessages)
                                    {
                                        <tr>
                                            <td>@message.MessageId</td>
                                            <td>@message.Subject</td>
                                            <td>@message.EnqueuedTime.ToString("yyyy-MM-dd HH:mm:ss")</td>
                                            <td>@message.DeliveryCount</td>
                                            <td>
                                                <button class="btn btn-sm btn-info" @onclick="() => ViewMessageDetails(message)">
                                                    Details
                                                </button>
                                            </td>
                                        </tr>
                                    }
                                </tbody>
                            </table>
                        </div>
                    }
                    else
                    {
                        <p>No messages found.</p>
                    }
                </div>
            </div>
        }

        @if (selectedMessage != null)
        {
            <div class="modal show d-block" tabindex="-1" style="background-color: rgba(0,0,0,0.5);">
                <div class="modal-dialog modal-lg modal-dialog-scrollable">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title">Message Details</h5>
                            <button type="button" class="btn-close" @onclick="CloseMessageDetails"></button>
                        </div>
                        <div class="modal-body">
                            <div class="mb-3">
                                <strong>Message ID:</strong> @selectedMessage.MessageId
                            </div>
                            <div class="mb-3">
                                <strong>Subject:</strong> @selectedMessage.Subject
                            </div>
                            <div class="mb-3">
                                <strong>Content Type:</strong> @selectedMessage.ContentType
                            </div>
                            <div class="mb-3">
                                <strong>Enqueued Time:</strong> @selectedMessage.EnqueuedTime.ToString("yyyy-MM-dd HH:mm:ss")
                            </div>
                            @if (selectedMessage.ScheduledEnqueueTime.HasValue)
                            {
                                <div class="mb-3">
                                    <strong>Scheduled Enqueue Time:</strong> @selectedMessage.ScheduledEnqueueTime.Value.ToString("yyyy-MM-dd HH:mm:ss")
                                </div>
                            }
                            <div class="mb-3">
                                <strong>Sequence Number:</strong> @selectedMessage.SequenceNumber
                            </div>
                            <div class="mb-3">
                                <strong>Delivery Count:</strong> @selectedMessage.DeliveryCount
                            </div>
                            @if (selectedMessage.Properties.Any())
                            {
                                <div class="mb-3">
                                    <strong>Application Properties:</strong>
                                    <pre class="bg-light p-2">@string.Join("\n", selectedMessage.Properties.Select(p => $"{p.Key}: {p.Value}"))</pre>
                                </div>
                            }
                            <div class="mb-3">
                                <strong>Body:</strong>
                                <pre class="bg-light p-2" style="max-height: 300px; overflow-y: auto;">@selectedMessage.Body</pre>
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" @onclick="CloseMessageDetails">Close</button>
                        </div>
                    </div>
                </div>
            </div>
        }

        @if (!string.IsNullOrEmpty(selectedTopic))
        {
            <div class="card mt-4">
                <div class="card-header">
                    <h4>@selectedTopic - Subscriptions</h4>
                    <button class="btn btn-sm btn-secondary" @onclick="CloseSubscriptions">Close</button>
                </div>
                <div class="card-body">
                    @if (isLoadingSubscriptions)
                    {
                        <div class="text-center">
                            <div class="spinner-border" role="status">
                                <span class="visually-hidden">Loading subscriptions...</span>
                            </div>
                        </div>
                    }
                    else if (subscriptions.Any())
                    {
                        <div class="list-group">
                            @foreach (var subscription in subscriptions)
                            {
                                <div class="list-group-item">
                                    <div class="d-flex justify-content-between align-items-center">
                                        <h5 class="mb-1">@subscription</h5>
                                        <div>
                                            <button class="btn btn-sm btn-primary me-1" @onclick="@(() => ViewSubscriptionMessages(selectedTopic, subscription, "Active"))">
                                                View Active
                                            </button>
                                            <button class="btn btn-sm btn-warning me-1" @onclick="@(() => ViewSubscriptionMessages(selectedTopic, subscription, "Scheduled"))">
                                                View Scheduled
                                            </button>
                                            <button class="btn btn-sm btn-danger" @onclick="@(() => ViewSubscriptionMessages(selectedTopic, subscription, "DeadLetter"))">
                                                View Dead Letter
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            }
                        </div>
                    }
                    else
                    {
                        <p>No subscriptions found.</p>
                    }
                </div>
            </div>
        }
    }
</div>

@code {
    private string connectionString = string.Empty;
    private string errorMessage = string.Empty;
    private bool isConnecting = false;
    private bool isLoading = false;
    private bool isLoadingMessages = false;
    private bool isLoadingSubscriptions = false;
    private string activeTab = "queues";
    
    private List<EntityInfo> queues = new();
    private List<EntityInfo> topics = new();
    private List<MessageInfo> messages = new();
    private List<string> subscriptions = new();
    
    private string selectedEntity = string.Empty;
    private string selectedMessageType = string.Empty;
    private string selectedTopic = string.Empty;
    private MessageInfo? selectedMessage = null;
    
    private string filterAttributeName = string.Empty;
    private string filterAttributeValue = string.Empty;
    private bool useRegexFilter = false;

    private IEnumerable<MessageInfo> FilteredMessages
    {
        get
        {
            if (string.IsNullOrWhiteSpace(filterAttributeName) && string.IsNullOrWhiteSpace(filterAttributeValue))
            {
                return messages;
            }

            return messages.Where(message =>
            {
                // If attribute name is specified, find that specific attribute
                if (!string.IsNullOrWhiteSpace(filterAttributeName))
                {
                    if (!message.Properties.TryGetValue(filterAttributeName, out var attributeValue))
                    {
                        return false; // Attribute doesn't exist in this message
                    }

                    // If no value filter specified, just check attribute existence
                    if (string.IsNullOrWhiteSpace(filterAttributeValue))
                    {
                        return true;
                    }

                    var valueStr = attributeValue?.ToString() ?? string.Empty;
                    
                    if (useRegexFilter)
                    {
                        try
                        {
                            return System.Text.RegularExpressions.Regex.IsMatch(valueStr, filterAttributeValue);
                        }
                        catch
                        {
                            // Invalid regex, fall back to literal match
                            return valueStr.Contains(filterAttributeValue, StringComparison.OrdinalIgnoreCase);
                        }
                    }
                    else
                    {
                        return valueStr.Contains(filterAttributeValue, StringComparison.OrdinalIgnoreCase);
                    }
                }
                else if (!string.IsNullOrWhiteSpace(filterAttributeValue))
                {
                    // Only value specified, search across all attributes
                    foreach (var prop in message.Properties)
                    {
                        var valueStr = prop.Value?.ToString() ?? string.Empty;
                        
                        if (useRegexFilter)
                        {
                            try
                            {
                                if (System.Text.RegularExpressions.Regex.IsMatch(valueStr, filterAttributeValue))
                                {
                                    return true;
                                }
                            }
                            catch
                            {
                                // Invalid regex, fall back to literal match
                                if (valueStr.Contains(filterAttributeValue, StringComparison.OrdinalIgnoreCase))
                                {
                                    return true;
                                }
                            }
                        }
                        else
                        {
                            if (valueStr.Contains(filterAttributeValue, StringComparison.OrdinalIgnoreCase))
                            {
                                return true;
                            }
                        }
                    }
                    return false;
                }

                return true;
            });
        }
    }

    private async Task ConnectAsync()
    {
        isConnecting = true;
        errorMessage = string.Empty;
        
        try
        {
            var success = await ServiceBusService.ConnectAsync(connectionString);
            if (success)
            {
                await LoadQueuesAsync();
            }
            else
            {
                errorMessage = "Failed to connect. Please check your connection string.";
            }
        }
        catch (Exception ex)
        {
            errorMessage = $"Error: {ex.Message}";
        }
        finally
        {
            isConnecting = false;
        }
    }

    private void Disconnect()
    {
        ServiceBusService.Disconnect();
        queues.Clear();
        topics.Clear();
        messages.Clear();
        subscriptions.Clear();
        selectedEntity = string.Empty;
        selectedTopic = string.Empty;
        activeTab = "queues";
    }

    private async Task LoadQueuesAsync()
    {
        activeTab = "queues";
        isLoading = true;
        selectedEntity = string.Empty;
        selectedTopic = string.Empty;
        
        try
        {
            queues = await ServiceBusService.GetQueuesAsync();
        }
        finally
        {
            isLoading = false;
        }
    }

    private async Task LoadTopicsAsync()
    {
        activeTab = "topics";
        isLoading = true;
        selectedEntity = string.Empty;
        selectedTopic = string.Empty;
        
        try
        {
            topics = await ServiceBusService.GetTopicsAsync();
        }
        finally
        {
            isLoading = false;
        }
    }

    private async Task ViewQueueMessages(string queueName, string messageType)
    {
        selectedEntity = queueName;
        selectedMessageType = messageType;
        selectedTopic = string.Empty;
        isLoadingMessages = true;
        
        try
        {
            messages = await ServiceBusService.GetMessagesAsync(queueName, messageType);
        }
        finally
        {
            isLoadingMessages = false;
        }
    }

    private void CloseMessages()
    {
        selectedEntity = string.Empty;
        selectedMessageType = string.Empty;
        messages.Clear();
        ClearFilters();
    }

    private void ClearFilters()
    {
        filterAttributeName = string.Empty;
        filterAttributeValue = string.Empty;
        useRegexFilter = false;
    }

    private void ViewMessageDetails(MessageInfo message)
    {
        selectedMessage = message;
    }

    private void CloseMessageDetails()
    {
        selectedMessage = null;
    }

    private async Task ViewTopicSubscriptions(string topicName)
    {
        selectedTopic = topicName;
        selectedEntity = string.Empty;
        isLoadingSubscriptions = true;
        
        try
        {
            subscriptions = await ServiceBusService.GetSubscriptionsAsync(topicName);
        }
        finally
        {
            isLoadingSubscriptions = false;
        }
    }

    private void CloseSubscriptions()
    {
        selectedTopic = string.Empty;
        subscriptions.Clear();
    }

    private async Task ViewSubscriptionMessages(string topicName, string subscriptionName, string messageType)
    {
        selectedEntity = $"{topicName}/{subscriptionName}";
        selectedMessageType = messageType;
        isLoadingMessages = true;
        
        try
        {
            messages = await ServiceBusService.GetSubscriptionMessagesAsync(topicName, subscriptionName, messageType);
        }
        finally
        {
            isLoadingMessages = false;
        }
    }
}
