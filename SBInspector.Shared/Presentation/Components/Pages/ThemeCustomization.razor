@page "/theme-customization"
@using SBInspector.Shared.Core.Domain
@using SBInspector.Shared.Application.Services
@inject ThemeService ThemeService
@inject NavigationManager NavigationManager

<PageTitle>Theme Customization - Service Bus Inspector</PageTitle>

<div class="container-fluid mt-4">
    <h1 class="mb-4">
        <i class="bi bi-palette"></i> Theme Customization
    </h1>

    <div class="row">
        <div class="col-lg-8">
            <!-- Theme Preset Selection -->
            <div class="card mb-4">
                <div class="card-body">
                    <h5 class="card-title">
                        <i class="bi bi-sun"></i> Theme Preset
                    </h5>
                    
                    <div class="mb-3">
                        <label class="form-label">Select Theme</label>
                        <select class="form-select" @bind="selectedPreset" @bind:after="OnPresetChanged">
                            <option value="@ThemePreset.Light">Light Theme</option>
                            <option value="@ThemePreset.Dark">Dark Theme</option>
                            <option value="@ThemePreset.Custom">Custom Theme</option>
                        </select>
                        <small class="form-text text-muted">
                            @if (selectedPreset == ThemePreset.Light)
                            {
                                <text>Classic light theme with blue accents.</text>
                            }
                            else if (selectedPreset == ThemePreset.Dark)
                            {
                                <text>Dark theme optimized for low-light environments.</text>
                            }
                            else
                            {
                                <text>Create your own custom theme with personalized colors.</text>
                            }
                        </small>
                    </div>
                </div>
            </div>

            @if (selectedPreset == ThemePreset.Custom)
            {
                <!-- Custom Theme Configuration -->
                <div class="card mb-4">
                    <div class="card-body">
                        <h5 class="card-title">
                            <i class="bi bi-paint-bucket"></i> Custom Theme Configuration
                        </h5>
                        
                        <div class="mb-3">
                            <label class="form-label">Theme Name</label>
                            <input type="text" class="form-control" @bind="customTheme.Name" placeholder="My Custom Theme" />
                        </div>

                        <div class="mb-3">
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="darkModeCheck" @bind="customTheme.IsDarkMode" />
                                <label class="form-check-label" for="darkModeCheck">
                                    Use Dark Mode
                                </label>
                            </div>
                            <small class="form-text text-muted">
                                Dark mode will apply colors optimized for low-light viewing.
                            </small>
                        </div>

                        <hr />

                        <h6 class="mb-3">Primary Colors</h6>
                        <div class="row g-3 mb-3">
                            <div class="col-md-6">
                                <label class="form-label">Primary Color</label>
                                <input type="color" class="form-control form-control-color w-100" @bind="customTheme.Primary" />
                                <small class="form-text text-muted">Main brand color for buttons and accents</small>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">Secondary Color</label>
                                <input type="color" class="form-control form-control-color w-100" @bind="customTheme.Secondary" />
                                <small class="form-text text-muted">Secondary accent color</small>
                            </div>
                        </div>

                        <h6 class="mb-3">Application Bar</h6>
                        <div class="row g-3 mb-3">
                            <div class="col-md-6">
                                <label class="form-label">AppBar Background</label>
                                <input type="color" class="form-control form-control-color w-100" @bind="customTheme.AppbarBackground" />
                                <small class="form-text text-muted">Top navigation bar background</small>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">AppBar Text</label>
                                <input type="color" class="form-control form-control-color w-100" @bind="customTheme.AppbarText" />
                                <small class="form-text text-muted">Top navigation bar text color</small>
                            </div>
                        </div>

                        <h6 class="mb-3">Background & Surface</h6>
                        <div class="row g-3 mb-3">
                            <div class="col-md-6">
                                <label class="form-label">Background Color</label>
                                <input type="color" class="form-control form-control-color w-100" @bind="customTheme.Background" />
                                <small class="form-text text-muted">Main background color</small>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">Surface Color</label>
                                <input type="color" class="form-control form-control-color w-100" @bind="customTheme.Surface" />
                                <small class="form-text text-muted">Card and panel background</small>
                            </div>
                        </div>

                        <h6 class="mb-3">Navigation Drawer</h6>
                        <div class="row g-3 mb-3">
                            <div class="col-md-6">
                                <label class="form-label">Drawer Background</label>
                                <input type="color" class="form-control form-control-color w-100" @bind="customTheme.DrawerBackground" />
                                <small class="form-text text-muted">Side navigation background</small>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">Drawer Text</label>
                                <input type="color" class="form-control form-control-color w-100" @bind="customTheme.DrawerText" />
                                <small class="form-text text-muted">Side navigation text color</small>
                            </div>
                        </div>

                        <h6 class="mb-3">Layout Properties</h6>
                        <div class="row g-3 mb-3">
                            <div class="col-md-6">
                                <label class="form-label">Border Radius</label>
                                <input type="text" class="form-control" @bind="customTheme.DefaultBorderRadius" placeholder="4px" />
                                <small class="form-text text-muted">Default border radius (e.g., 4px, 8px)</small>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Quick Presets for Custom Theme -->
                <div class="card mb-4">
                    <div class="card-body">
                        <h5 class="card-title">
                            <i class="bi bi-stars"></i> Quick Presets
                        </h5>
                        <p class="text-muted small">Load a pre-configured color scheme to customize further</p>
                        <h6 class="mb-2">Light Themes</h6>
                        <div class="btn-group mb-3" role="group">
                            <button type="button" class="btn btn-outline-primary" @onclick="@(() => LoadQuickPreset("Ocean"))">
                                Ocean Blue
                            </button>
                            <button type="button" class="btn btn-outline-success" @onclick="@(() => LoadQuickPreset("Forest"))">
                                Forest Green
                            </button>
                            <button type="button" class="btn btn-outline-danger" @onclick="@(() => LoadQuickPreset("Sunset"))">
                                Sunset Orange
                            </button>
                            <button type="button" class="btn btn-outline-secondary" @onclick="@(() => LoadQuickPreset("Monochrome"))">
                                Monochrome
                            </button>
                        </div>
                        <h6 class="mb-2">Dark Themes</h6>
                        <div class="btn-group" role="group">
                            <button type="button" class="btn btn-outline-primary" @onclick="@(() => LoadQuickPreset("OceanDark"))">
                                Ocean Dark
                            </button>
                            <button type="button" class="btn btn-outline-success" @onclick="@(() => LoadQuickPreset("ForestDark"))">
                                Forest Dark
                            </button>
                            <button type="button" class="btn btn-outline-danger" @onclick="@(() => LoadQuickPreset("SunsetDark"))">
                                Sunset Dark
                            </button>
                            <button type="button" class="btn btn-outline-secondary" @onclick="@(() => LoadQuickPreset("MonochromeDark"))">
                                Monochrome Dark
                            </button>
                        </div>
                    </div>
                </div>
            }

            <!-- Save Button -->
            <div class="d-grid gap-2 d-md-flex justify-content-md-end mb-4">
                <button class="btn btn-secondary btn-lg me-2" @onclick="ResetToDefault">
                    <i class="bi bi-arrow-counterclockwise me-2"></i>
                    Reset to Default
                </button>
                <button class="btn btn-primary btn-lg" @onclick="SaveTheme" disabled="@isSaving">
                    @if (isSaving)
                    {
                        <span class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span>
                    }
                    else
                    {
                        <i class="bi bi-save me-2"></i>
                    }
                    Save Theme
                </button>
            </div>
        </div>

        <!-- Info Panel -->
        <div class="col-lg-4">
            <div class="card">
                <div class="card-body">
                    <h5 class="card-title">
                        <i class="bi bi-info-circle"></i> About Theme Customization
                    </h5>
                    <p class="card-text">
                        Customize the look and feel of SBInspector to match your preferences.
                    </p>
                    <hr />
                    <h6>Theme Presets</h6>
                    <ul class="small">
                        <li><strong>Light Theme:</strong> Classic light theme with blue accents.</li>
                        <li><strong>Dark Theme:</strong> Dark theme for reduced eye strain in low-light.</li>
                        <li><strong>Custom Theme:</strong> Create your own personalized color scheme.</li>
                    </ul>
                    <hr />
                    <h6>Tips</h6>
                    <p class="small">
                        <i class="bi bi-lightbulb"></i> Use the quick presets as a starting point for your custom theme!
                    </p>
                </div>
            </div>

            <!-- Theme Preview -->
            <div class="card mt-3">
                <div class="card-body">
                    <h5 class="card-title">
                        <i class="bi bi-eye"></i> Live Preview
                    </h5>
                    <p class="small text-muted">
                        Your theme changes are applied in real-time. Navigate to other pages to see the full effect.
                    </p>
                </div>
            </div>
        </div>
    </div>

    @if (!string.IsNullOrEmpty(successMessage))
    {
        <div class="alert alert-success alert-dismissible fade show position-fixed top-0 start-50 translate-middle-x mt-3" style="z-index: 9999; min-width: 300px;" role="alert">
            <i class="bi bi-check-circle"></i> @successMessage
            <button type="button" class="btn-close" @onclick="() => successMessage = string.Empty"></button>
        </div>
    }

    @if (!string.IsNullOrEmpty(errorMessage))
    {
        <div class="alert alert-danger alert-dismissible fade show position-fixed top-0 start-50 translate-middle-x mt-3" style="z-index: 9999; min-width: 300px;" role="alert">
            <i class="bi bi-exclamation-triangle"></i> @errorMessage
            <button type="button" class="btn-close" @onclick="() => errorMessage = string.Empty"></button>
        </div>
    }
</div>

@code {
    private ThemePreset selectedPreset = ThemePreset.Custom;
    private ThemeConfiguration customTheme = new();
    private bool isSaving = false;
    private string successMessage = string.Empty;
    private string errorMessage = string.Empty;

    protected override void OnInitialized()
    {
        selectedPreset = ThemeService.CurrentPreset;
        customTheme = CloneThemeConfiguration(ThemeService.GetCustomThemeConfiguration());
    }

    private async Task OnPresetChanged()
    {
        try
        {
            await ThemeService.SetPresetAsync(selectedPreset);
            StateHasChanged();
        }
        catch (Exception ex)
        {
            errorMessage = $"Error changing theme preset: {ex.Message}";
            await Task.Delay(5000);
            errorMessage = string.Empty;
        }
    }

    private async Task SaveTheme()
    {
        isSaving = true;
        errorMessage = string.Empty;
        successMessage = string.Empty;

        try
        {
            if (selectedPreset == ThemePreset.Custom)
            {
                await ThemeService.SaveCustomThemeAsync(customTheme);
            }
            await ThemeService.SetPresetAsync(selectedPreset);

            successMessage = "Theme saved successfully!";
            
            await Task.Delay(3000);
            successMessage = string.Empty;
        }
        catch (Exception ex)
        {
            errorMessage = $"Error saving theme: {ex.Message}";
            await Task.Delay(5000);
            errorMessage = string.Empty;
        }
        finally
        {
            isSaving = false;
        }
    }

    private void ResetToDefault()
    {
        customTheme = new ThemeConfiguration
        {
            Name = "Custom",
            IsDarkMode = false,
            Primary = "#00836b",
            Secondary = "#6c757d",
            Background = "#f5f5f5",
            Surface = "#ffffff",
            AppbarBackground = "#00836b",
            AppbarText = "#ffffff",
            DrawerBackground = "#f8f9fa",
            DrawerText = "#212529",
            DefaultBorderRadius = "4px"
        };
        StateHasChanged();
    }

    private void LoadQuickPreset(string preset)
    {
        switch (preset)
        {
            case "Ocean":
                customTheme.Primary = "#0077be";
                customTheme.Secondary = "#00a8cc";
                customTheme.Background = "#e6f3f9";
                customTheme.Surface = "#ffffff";
                customTheme.AppbarBackground = "#005f99";
                customTheme.AppbarText = "#ffffff";
                customTheme.DrawerBackground = "#b3ddf2";
                customTheme.DrawerText = "#003d66";
                customTheme.IsDarkMode = false;
                break;
            case "Forest":
                customTheme.Primary = "#2d5016";
                customTheme.Secondary = "#6b8e23";
                customTheme.Background = "#f0f4e8";
                customTheme.Surface = "#ffffff";
                customTheme.AppbarBackground = "#2d5016";
                customTheme.AppbarText = "#ffffff";
                customTheme.DrawerBackground = "#d4e4c0";
                customTheme.DrawerText = "#1a2e0d";
                customTheme.IsDarkMode = false;
                break;
            case "Sunset":
                customTheme.Primary = "#ff6b35";
                customTheme.Secondary = "#f7931e";
                customTheme.Background = "#fff3e0";
                customTheme.Surface = "#ffffff";
                customTheme.AppbarBackground = "#d84315";
                customTheme.AppbarText = "#ffffff";
                customTheme.DrawerBackground = "#ffe0b2";
                customTheme.DrawerText = "#8b2e0b";
                customTheme.IsDarkMode = false;
                break;
            case "Monochrome":
                customTheme.Primary = "#424242";
                customTheme.Secondary = "#757575";
                customTheme.Background = "#fafafa";
                customTheme.Surface = "#ffffff";
                customTheme.AppbarBackground = "#212121";
                customTheme.AppbarText = "#ffffff";
                customTheme.DrawerBackground = "#e0e0e0";
                customTheme.DrawerText = "#212121";
                customTheme.IsDarkMode = false;
                break;
            case "OceanDark":
                customTheme.Primary = "#4fc3f7";
                customTheme.Secondary = "#29b6f6";
                customTheme.Background = "#0d1117";
                customTheme.Surface = "#1e2530";
                customTheme.AppbarBackground = "#0a4d6e";
                customTheme.AppbarText = "#e0f7ff";
                customTheme.DrawerBackground = "#1a2332";
                customTheme.DrawerText = "#b3e5fc";
                customTheme.IsDarkMode = true;
                break;
            case "ForestDark":
                customTheme.Primary = "#81c784";
                customTheme.Secondary = "#aed581";
                customTheme.Background = "#1a1a1a";
                customTheme.Surface = "#2d2d2d";
                customTheme.AppbarBackground = "#1b3a0f";
                customTheme.AppbarText = "#c8e6c9";
                customTheme.DrawerBackground = "#212121";
                customTheme.DrawerText = "#c8e6c9";
                customTheme.IsDarkMode = true;
                break;
            case "SunsetDark":
                customTheme.Primary = "#ff8a65";
                customTheme.Secondary = "#ffab91";
                customTheme.Background = "#1a1a1a";
                customTheme.Surface = "#2d2d2d";
                customTheme.AppbarBackground = "#8b2e0b";
                customTheme.AppbarText = "#ffe0b2";
                customTheme.DrawerBackground = "#212121";
                customTheme.DrawerText = "#ffccbc";
                customTheme.IsDarkMode = true;
                break;
            case "MonochromeDark":
                customTheme.Primary = "#9e9e9e";
                customTheme.Secondary = "#bdbdbd";
                customTheme.Background = "#121212";
                customTheme.Surface = "#1e1e1e";
                customTheme.AppbarBackground = "#0d0d0d";
                customTheme.AppbarText = "#e0e0e0";
                customTheme.DrawerBackground = "#1a1a1a";
                customTheme.DrawerText = "#e0e0e0";
                customTheme.IsDarkMode = true;
                break;
        }
        StateHasChanged();
    }

    private ThemeConfiguration CloneThemeConfiguration(ThemeConfiguration source)
    {
        return new ThemeConfiguration
        {
            Name = source.Name,
            IsDarkMode = source.IsDarkMode,
            Primary = source.Primary,
            Secondary = source.Secondary,
            Background = source.Background,
            Surface = source.Surface,
            AppbarBackground = source.AppbarBackground,
            AppbarText = source.AppbarText,
            DrawerBackground = source.DrawerBackground,
            DrawerText = source.DrawerText,
            DefaultBorderRadius = source.DefaultBorderRadius
        };
    }
}
