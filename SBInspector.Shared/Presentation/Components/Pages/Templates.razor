@page "/templates"
@using SBInspector.Shared.Core.Interfaces
@using SBInspector.Shared.Core.Domain
@using SBInspector.Shared.Presentation.Components.UI
@using MudBlazor
@inject IStorageService StorageService
@inject IDialogService DialogService

<PageTitle>Message Templates - SBInspector</PageTitle>

<MudContainer MaxWidth="MaxWidth.ExtraLarge" Class="mt-4">
    <MudStack Row="true" AlignItems="AlignItems.Center" Justify="Justify.SpaceBetween" Class="mb-4">
        <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="2">
            <MudIcon Icon="@Icons.Material.Filled.Description" Size="Size.Large" />
            <MudText Typo="Typo.h4">Message Templates</MudText>
        </MudStack>
        <MudButton Variant="Variant.Filled" Color="Color.Primary" OnClick="ShowCreateModal" StartIcon="@Icons.Material.Filled.Add">
            New Template
        </MudButton>
    </MudStack>

    @if (isLoading)
    {
        <MudStack AlignItems="AlignItems.Center" Spacing="2" Class="py-5">
            <MudProgressCircular Color="Color.Primary" Size="Size.Large" />
            <MudText Typo="Typo.body1">Loading templates...</MudText>
        </MudStack>
    }
    else if (!templates.Any())
    {
        <MudAlert Severity="Severity.Info" Icon="@Icons.Material.Filled.Info">
            No message templates found. Create your first template to get started!
        </MudAlert>
    }
    else
    {
        <MudPaper Class="pa-3" Elevation="1" >
            <MudTable Items="@templates.OrderByDescending(t => t.LastUsedAt).ThenByDescending(t => t.CreatedAt)" Dense="true" Hover="true" Bordered="true" Striped="true">
                <HeaderContent>
                    <MudTh>Name</MudTh>
                    <MudTh>Subject</MudTh>
                    <MudTh>Content Type</MudTh>
                    <MudTh>Created</MudTh>
                    <MudTh>Last Used</MudTh>
                    <MudTh Style="width: 150px;">Actions</MudTh>
                </HeaderContent>
                <RowTemplate>
                    <MudTd DataLabel="Name">
                        <MudText Typo="Typo.body2"><strong>@context.Name</strong></MudText>
                    </MudTd>
                    <MudTd DataLabel="Subject">@(context.Subject ?? "-")</MudTd>
                    <MudTd DataLabel="Content Type">@(context.ContentType ?? "text/plain")</MudTd>
                    <MudTd DataLabel="Created">@context.CreatedAt.ToLocalTime().ToString("g")</MudTd>
                    <MudTd DataLabel="Last Used">@(context.LastUsedAt?.ToLocalTime().ToString("g") ?? "Never")</MudTd>
                    <MudTd DataLabel="Actions">
                        <MudStack Row="true" Spacing="0">
                            <MudIconButton Icon="@Icons.Material.Filled.Visibility" Color="Color.Info" Size="Size.Small" OnClick="@(() => ShowViewModal(context))" Title="View" />
                            <MudIconButton Icon="@Icons.Material.Filled.Edit" Color="Color.Primary" Size="Size.Small" OnClick="@(() => ShowEditModal(context))" Title="Edit" />
                            <MudIconButton Icon="@Icons.Material.Filled.Delete" Color="Color.Error" Size="Size.Small" OnClick="@(() => ShowDeleteConfirmation(context))" Title="Delete" />
                        </MudStack>
                    </MudTd>
                </RowTemplate>
            </MudTable>

            <MudStack Row="true" AlignItems="AlignItems.Center" Class="mt-3">
                <MudText Typo="Typo.caption" Color="Color.Secondary">Total templates: @templates.Count</MudText>
            </MudStack>
        </MudPaper>
    }

    @if (!string.IsNullOrEmpty(successMessage))
    {
        <MudAlert Severity="Severity.Success" Variant="Variant.Filled" Icon="@Icons.Material.Filled.CheckCircle" Class="mt-3" CloseIconClicked="() => successMessage = string.Empty">@successMessage</MudAlert>
    }

    @if (!string.IsNullOrEmpty(errorMessage))
    {
        <MudAlert Severity="Severity.Error" Variant="Variant.Filled" Icon="@Icons.Material.Filled.Error" Class="mt-3" CloseIconClicked="() => errorMessage = string.Empty">@errorMessage</MudAlert>
    }
</MudContainer>

@if (isViewModalVisible && selectedTemplate != null)
{
    <MudDialog @bind-Visible="isViewModalVisible" Options="@(new DialogOptions { MaxWidth = MaxWidth.Large, FullWidth = true, CloseButton = true })">
        <TitleContent>
            <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="2">
                <MudIcon Icon="@Icons.Material.Filled.Visibility" />
                <MudText Typo="Typo.h6">View Template: @selectedTemplate.Name</MudText>
            </MudStack>
        </TitleContent>
        <DialogContent>
            <MudStack Spacing="3">
                <div>
                    <MudText Typo="Typo.subtitle2" Class="mb-1"><strong>Template Name</strong></MudText>
                    <MudText>@selectedTemplate.Name</MudText>
                </div>

                <div>
                    <MudText Typo="Typo.subtitle2" Class="mb-1"><strong>Message Body</strong></MudText>
                    <MudPaper Class="pa-3" Elevation="0" Style="max-height: 300px; overflow-y: auto;">
                        <pre style="margin: 0; white-space: pre-wrap; word-wrap: break-word;">@selectedTemplate.MessageBody</pre>
                    </MudPaper>
                </div>

                <MudGrid>
                    <MudItem xs="6">
                        <MudText Typo="Typo.subtitle2" Class="mb-1"><strong>Subject</strong></MudText>
                        <MudText>@(selectedTemplate.Subject ?? "-")</MudText>
                    </MudItem>
                    <MudItem xs="6">
                        <MudText Typo="Typo.subtitle2" Class="mb-1"><strong>Content Type</strong></MudText>
                        <MudText>@(selectedTemplate.ContentType ?? "text/plain")</MudText>
                    </MudItem>
                </MudGrid>

                @if (selectedTemplate.Properties?.Any() == true)
                {
                    <div>
                        <MudText Typo="Typo.subtitle2" Class="mb-2"><strong>Application Properties</strong></MudText>
                        <MudPaper Class="pa-2" Elevation="0" >
                            @foreach (var prop in selectedTemplate.Properties)
                            {
                                <MudStack Row="true" Spacing="1" Class="mb-1">
                                    <MudChip T="string" Size="Size.Small" Variant="Variant.Text">@prop.Key</MudChip>
                                    <MudText>=</MudText>
                                    <MudChip T="string" Size="Size.Small" Variant="Variant.Text" Color="Color.Primary">@prop.Value</MudChip>
                                </MudStack>
                            }
                        </MudPaper>
                    </div>
                }

                <MudGrid>
                    <MudItem xs="6">
                        <MudText Typo="Typo.subtitle2" Class="mb-1"><strong>Created</strong></MudText>
                        <MudText>@selectedTemplate.CreatedAt.ToLocalTime().ToString("g")</MudText>
                    </MudItem>
                    <MudItem xs="6">
                        <MudText Typo="Typo.subtitle2" Class="mb-1"><strong>Last Used</strong></MudText>
                        <MudText>@(selectedTemplate.LastUsedAt?.ToLocalTime().ToString("g") ?? "Never")</MudText>
                    </MudItem>
                </MudGrid>
            </MudStack>
        </DialogContent>
        <DialogActions>
            <MudButton Variant="Variant.Text" Color="Color.Secondary" OnClick="CloseViewModal" StartIcon="@Icons.Material.Filled.Close">
                Close
            </MudButton>
        </DialogActions>
    </MudDialog>
}

@code {
    private List<MessageTemplate> templates = new();
    private bool isLoading = false;
    private string errorMessage = string.Empty;
    private string successMessage = string.Empty;

    // View modal
    private bool isViewModalVisible = false;
    private MessageTemplate? selectedTemplate = null;

    protected override async Task OnInitializedAsync()
    {
        await LoadTemplatesAsync();
    }

    private async Task LoadTemplatesAsync()
    {
        isLoading = true;
        errorMessage = string.Empty;

        try
        {
            templates = await StorageService.GetMessageTemplatesAsync();
        }
        catch (Exception ex)
        {
            errorMessage = $"Error loading templates: {ex.Message}";
        }
        finally
        {
            isLoading = false;
        }
    }

    private async Task ShowCreateModal()
    {
        var parameters = new DialogParameters<MessageTemplateEditorModal>
        {
            { x => x.IsEditMode, false },
            { x => x.Template, null }
        };

        var options = new DialogOptions
        {
            MaxWidth = MaxWidth.Large,
            FullWidth = true,
            CloseButton = true
        };

        var dialog = await DialogService.ShowAsync<MessageTemplateEditorModal>(
            "New Template",
            parameters,
            options);

        var result = await dialog.Result;

        if (!result.Canceled && result.Data is MessageTemplate template)
        {
            try
            {
                await StorageService.SaveMessageTemplateAsync(template);
                await LoadTemplatesAsync();
                successMessage = "Template created successfully!";
            }
            catch (Exception ex)
            {
                errorMessage = $"Error saving template: {ex.Message}";
            }
        }
    }

    private async Task ShowEditModal(MessageTemplate template)
    {
        var parameters = new DialogParameters<MessageTemplateEditorModal>
        {
            { x => x.IsEditMode, true },
            { x => x.Template, template }
        };

        var options = new DialogOptions
        {
            MaxWidth = MaxWidth.Large,
            FullWidth = true,
            CloseButton = true
        };

        var dialog = await DialogService.ShowAsync<MessageTemplateEditorModal>(
            "Edit Template",
            parameters,
            options);

        var result = await dialog.Result;

        if (!result.Canceled && result.Data is MessageTemplate updatedTemplate)
        {
            try
            {
                await StorageService.SaveMessageTemplateAsync(updatedTemplate);
                await LoadTemplatesAsync();
                successMessage = "Template updated successfully!";
            }
            catch (Exception ex)
            {
                errorMessage = $"Error saving template: {ex.Message}";
            }
        }
    }

    private void ShowViewModal(MessageTemplate template)
    {
        selectedTemplate = template;
        isViewModalVisible = true;
    }

    private void CloseViewModal()
    {
        isViewModalVisible = false;
        selectedTemplate = null;
    }

    private async Task ShowDeleteConfirmation(MessageTemplate template)
    {
        var parameters = new DialogParameters<ConfirmationModal>
        {
            { x => x.Message, $"Are you sure you want to delete the template '{template.Name}'? This action cannot be undone." },
            { x => x.ConfirmText, "Delete" },
            { x => x.ConfirmColor, Color.Error },
            { x => x.ConfirmIconClass, "bi-trash" }
        };

        var options = new DialogOptions
        {
            MaxWidth = MaxWidth.Small,
            FullWidth = true,
            CloseButton = true
        };

        var dialog = await DialogService.ShowAsync<ConfirmationModal>(
            "Delete Template",
            parameters,
            options);

        var result = await dialog.Result;

        if (!result.Canceled)
        {
            try
            {
                await StorageService.DeleteMessageTemplateAsync(template.Id);
                await LoadTemplatesAsync();
                successMessage = $"Template '{template.Name}' deleted successfully!";
            }
            catch (Exception ex)
            {
                errorMessage = $"Error deleting template: {ex.Message}";
            }
        }
    }
}
