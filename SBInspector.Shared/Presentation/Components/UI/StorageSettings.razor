@using SBInspector.Shared.Core.Domain
@using SBInspector.Shared.Application.Services
@using MudBlazor
@inject StorageConfigurationService ConfigService

<MudCard Class="mud-elevation-2">
    <MudCardContent>
        <MudText Typo="Typo.h5">
            <MudIcon Icon="@Icons.Material.Filled.Settings" /> Storage Settings
        </MudText>
        
        <MudSelect T="StorageType" @bind-Value="selectedStorageType" Label="Storage Location" Margin="Margin.Normal" OnBlur="OnStorageTypeChanged">
            <MudSelectItem Value="StorageType.LocalStorage">Browser Local Storage (Web)</MudSelectItem>
            <MudSelectItem Value="StorageType.FileSystem">File System (Desktop - Recommended for Tauri)</MudSelectItem>
        </MudSelect>
        
        <MudText Typo="Typo.caption" Color="Color.Secondary">
            @if (selectedStorageType == StorageType.LocalStorage)
            {
                <text>Data is stored in browser localStorage. Best for web deployments.</text>
            }
            else
            {
                <text>Data is saved to files on your Desktop in 'SBInspector' folder. Best for Tauri desktop app.</text>
            }
        </MudText>
        
        @if (!string.IsNullOrEmpty(successMessage))
        {
            <MudAlert Severity="Severity.Success" Dense="true" OnClose="@(() => successMessage = string.Empty)">
                <MudIcon Icon="@Icons.Material.Filled.CheckCircle" /> @successMessage
            </MudAlert>
        }

        @if (!string.IsNullOrEmpty(infoMessage))
        {
            <MudAlert Severity="Severity.Info" Dense="true">
                <MudIcon Icon="@Icons.Material.Filled.Info" /> @infoMessage
            </MudAlert>
        }
    </MudCardContent>
</MudCard>

@code {
    private StorageType selectedStorageType;
    private string successMessage = string.Empty;
    private string infoMessage = string.Empty;

    protected override void OnInitialized()
    {
        var config = ConfigService.GetConfiguration();
        selectedStorageType = config.StorageType;
    }

    private async Task OnStorageTypeChanged()
    {
        try
        {
            await ConfigService.SetStorageTypeAsync(selectedStorageType);
            successMessage = "Storage type updated successfully!";
            infoMessage = "Please restart the application for changes to take full effect.";
        }
        catch (Exception ex)
        {
            successMessage = string.Empty;
            infoMessage = $"Error updating storage type: {ex.Message}";
        }
    }
}
