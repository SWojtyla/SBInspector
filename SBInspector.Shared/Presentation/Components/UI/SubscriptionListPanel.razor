@using SBInspector.Shared.Core.Domain
@using MudBlazor

<MudCard Class="mud-elevation-2 mt-4">
    <MudCardHeader>
        <MudStack Direction="Row" AlignItems="AlignItems.Center" JustifyContent="SpaceBetween">
            <MudStack>
                <MudText Typo="Typo.h5"><MudIcon Icon="@Icons.Material.Filled.Folder" /> @TopicName</MudText>
                <MudChip T=SubscriptionInfo Color="Color.Primary" Size="Size.Small">Subscriptions (@Subscriptions.Count)</MudChip>
            </MudStack>
            <MudButton Variant="Variant.Outlined" Color="Color.Secondary" OnClick="HandleClose" StartIcon="@Icons.Material.Filled.Close">Close</MudButton>
        </MudStack>
    </MudCardHeader>
    <MudCardContent>
        @if (IsLoading)
        {
            <MudStack AlignItems="AlignItems.Center" Spacing="2" Class="my-4">
                <MudProgressCircular Color="Color.Primary" Size="Size.Large" />
                <MudText Typo="Typo.body1">Loading subscriptions...</MudText>
            </MudStack>
        }
        else if (Subscriptions.Any())
        {
            <MudTextField @bind-Value="searchTerm" Placeholder="Search subscriptions..." Adornment="Adornment.Start" AdornmentIcon="@Icons.Material.Filled.Search" Margin="Margin.Dense" Class="mb-3" />
            <MudStack Spacing="2">
                @foreach (var subscription in FilteredSubscriptions)
                {
                    <MudPaper Class="pa-2">
                        <MudStack Direction="Row" AlignItems="AlignItems.Center" JustifyContent="SpaceBetween">
                            <MudStack>
                                <MudText Typo="Typo.h6"><MudIcon Icon="@Icons.Material.Filled.Email" /> @subscription.Name</MudText>
                                <MudChip T=SubscriptionInfo Color="@(subscription.Status == "Active" ? Color.Success : Color.Default)" Size="Size.Small">@subscription.Status</MudChip>
                                <MudStack Direction="Row" Spacing="1">
                                    <MudChip T=SubscriptionInfo Color="Color.Primary" Size="Size.Small"><MudIcon Icon="@Icons.Material.Filled.Inbox" /> @subscription.ActiveMessageCount</MudChip>
                                    <MudChip T=SubscriptionInfo Color="Color.Error" Size="Size.Small"><MudIcon Icon="@Icons.Material.Filled.ReportProblem" /> @subscription.DeadLetterMessageCount</MudChip>
                                </MudStack>
                            </MudStack>
                            <MudStack Direction="Row" Spacing="1">
                                @if (subscription.Status == "Active")
                                {
                                    <MudButton Variant="Variant.Outlined" Color="Color.Secondary" Size="Size.Small" OnClick="@(() => OnToggleStatus.InvokeAsync((TopicName, subscription.Name)))" StartIcon="@Icons.Material.Filled.PauseCircle">Disable</MudButton>
                                }
                                else
                                {
                                    <MudButton Variant="Variant.Outlined" Color="Color.Success" Size="Size.Small" OnClick="@(() => OnToggleStatus.InvokeAsync((TopicName, subscription.Name)))" StartIcon="@Icons.Material.Filled.PlayCircle">Enable</MudButton>
                                }
                                <MudButton Variant="Variant.Outlined" Color="Color.Primary" Size="Size.Small" OnClick="@(() => OnViewMessages.InvokeAsync((TopicName, subscription.Name, "Active")))" StartIcon="@Icons.Material.Filled.Inbox">Active</MudButton>
                                <MudButton Variant="Variant.Outlined" Color="Color.Warning" Size="Size.Small" OnClick="@(() => OnViewMessages.InvokeAsync((TopicName, subscription.Name, "Scheduled")))" StartIcon="@Icons.Material.Filled.Schedule">Scheduled</MudButton>
                                <MudButton Variant="Variant.Outlined" Color="Color.Error" Size="Size.Small" OnClick="@(() => OnViewMessages.InvokeAsync((TopicName, subscription.Name, "DeadLetter")))" StartIcon="@Icons.Material.Filled.ReportProblem">DLQ</MudButton>
                            </MudStack>
                        </MudStack>
                    </MudPaper>
                }
            </MudStack>
            
            @if (!FilteredSubscriptions.Any())
            {
                <MudAlert Severity="Severity.Info" Class="mt-3">No subscriptions match your search criteria.</MudAlert>
            }
        }
        else
        {
            <MudAlert Severity="Severity.Warning"><MudIcon Icon="@Icons.Material.Filled.Info" /> No subscriptions found for this topic.</MudAlert>
        }
    </MudCardContent>
</MudCard>

@code {
    [Parameter]
    public string TopicName { get; set; } = string.Empty;

    [Parameter]
    public List<SubscriptionInfo> Subscriptions { get; set; } = new();

    [Parameter]
    public bool IsLoading { get; set; }

    [Parameter]
    public EventCallback OnClose { get; set; }

    [Parameter]
    public EventCallback<(string TopicName, string SubscriptionName, string MessageType)> OnViewMessages { get; set; }

    [Parameter]
    public EventCallback<(string TopicName, string SubscriptionName)> OnToggleStatus { get; set; }

    private string searchTerm = string.Empty;

    private IEnumerable<SubscriptionInfo> FilteredSubscriptions
    {
        get
        {
            if (string.IsNullOrWhiteSpace(searchTerm))
            {
                return Subscriptions;
            }
            
            return Subscriptions.Where(s => s.Name.Contains(searchTerm, StringComparison.OrdinalIgnoreCase));
        }
    }

    private async Task HandleClose()
    {
        await OnClose.InvokeAsync();
    }
}
