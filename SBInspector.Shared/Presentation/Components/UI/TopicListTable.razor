@using SBInspector.Shared.Core.Domain
@using MudBlazor

<MudPaper Class="pa-2 mb-3">
    <MudStack Direction="Row" AlignItems="AlignItems.Center" JustifyContent="JustifyContent.SpaceBetween" Class="mb-3">
        <MudText Typo="Typo.h5">Topics (@FilteredTopics.Count())</MudText>
        @if (Topics.Any())
        {
            <MudTextField @bind-Value="searchTerm" Placeholder="Search topics..." Adornment="Adornment.Start" AdornmentIcon="@Icons.Material.Filled.Search" Margin="Margin.Dense" />
        }
    </MudStack>
    
    @if (Topics.Any())
    {
        <MudTable Items="@FilteredTopics" Dense="true" Hover="true" Bordered="true" Striped="true">
            <HeaderContent>
                <MudTh><MudButton Variant="Variant.Text" OnClick="HandleSortColumn">Name @GetSortIcon()</MudButton></MudTh>
                <MudTh Align="Center">Status</MudTh>
                <MudTh Align="Center">Actions</MudTh>
            </HeaderContent>
            <RowTemplate>
                <MudTd><MudText Typo="Typo.subtitle2">@context.Name</MudText></MudTd>
                <MudTd Align="Center"><MudChip T=EntityInfo Color="@(context.Status == "Active" ? Color.Success : Color.Default)">@context.Status</MudChip></MudTd>
                <MudTd Align="Center">
                    @if (context.Status == "Active")
                    {
                        <MudButton Variant="Variant.Outlined" Color="Color.Secondary" Size="Size.Small" OnClick="@(() => OnToggleStatus.InvokeAsync(context.Name))" StartIcon="@Icons.Material.Filled.PauseCircle">Disable</MudButton>
                    }
                    else
                    {
                        <MudButton Variant="Variant.Outlined" Color="Color.Success" Size="Size.Small" OnClick="@(() => OnToggleStatus.InvokeAsync(context.Name))" StartIcon="@Icons.Material.Filled.PlayCircle">Enable</MudButton>
                    }
                    <MudButton Variant="Variant.Outlined" Color="Color.Info" Size="Size.Small" OnClick="() => OnViewSubscriptions.InvokeAsync(context.Name)" StartIcon="@Icons.Material.Filled.List">View Subscriptions</MudButton>
                </MudTd>
            </RowTemplate>
        </MudTable>
        
        @if (!FilteredTopics.Any())
        {
            <MudAlert Severity="Severity.Info" Class="mt-3">No topics match your search criteria.</MudAlert>
        }
    }
    else
    {
        <MudAlert Severity="Severity.Warning"><MudIcon Icon="@Icons.Material.Filled.Info" /> No topics found in this namespace.</MudAlert>
    }
</MudPaper>

@code {
    [Parameter]
    public List<EntityInfo> Topics { get; set; } = new();

    [Parameter]
    public EventCallback<string> OnViewSubscriptions { get; set; }

    [Parameter]
    public EventCallback<string> OnToggleStatus { get; set; }

    private string searchTerm = string.Empty;
    private bool sortAscending = true;

    private IEnumerable<EntityInfo> FilteredTopics
    {
        get
        {
            var filtered = Topics.AsEnumerable();
            
            if (!string.IsNullOrWhiteSpace(searchTerm))
            {
                filtered = filtered.Where(t => t.Name.Contains(searchTerm, StringComparison.OrdinalIgnoreCase));
            }
            
            filtered = sortAscending 
                ? filtered.OrderBy(t => t.Name) 
                : filtered.OrderByDescending(t => t.Name);
            
            return filtered;
        }
    }

    private string GetSortIcon()
    {
        return sortAscending ? "▲" : "▼";
    }

    private void HandleSortColumn()
    {
        sortAscending = !sortAscending;
    }
}
