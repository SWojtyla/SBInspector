@using SBInspector.Shared.Core.Domain
@using SBInspector.Shared.Application.Services
@using MudBlazor
@inject ColumnConfigurationService ColumnConfigService

<MudDialog>
    <DialogContent>
        <MudPaper Class="pa-4">
            <MudText Typo="Typo.h6" Class="mb-3"><MudIcon Icon="@Icons.Material.Filled.ViewColumn" /> Configure Table Columns</MudText>
            <MudText Typo="Typo.body2" Class="mb-3" Color="Color.Info">
                <MudIcon Icon="@Icons.Material.Filled.Info" Size="Size.Small" /> Drag and drop columns to reorder them
            </MudText>
            
            <MudDropContainer T="ColumnDefinition" Items="@Columns" ItemsSelector="@((item, dropzone) => GetDropZoneForColumn(item) == dropzone)" ItemDropped="@OnColumnDropped" Class="d-flex flex-column">
                <ChildContent>
                    <MudText Typo="Typo.subtitle2" Class="mb-2">Default Columns</MudText>
                    <MudDropZone T="ColumnDefinition" Identifier="@SystemDropZone" Class="mud-height-full" />

                    @if (Columns.Any(c => !c.IsSystemColumn))
                    {
                        <MudDivider Class="my-3" />
                        <MudText Typo="Typo.subtitle2" Class="mb-2">Custom Columns</MudText>
                        <MudDropZone T="ColumnDefinition" Identifier="@CustomDropZone" Class="mud-height-full" />
                    }
                </ChildContent>
                <ItemRenderer>
                    @if (context.IsSystemColumn)
                    {
                        <MudListItem T="string" Dense="true" Style="cursor: move; user-select: none;">
                            <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="2">
                                <MudIcon Icon="@Icons.Material.Filled.DragIndicator" Size="Size.Small" Color="Color.Default" />
                                <MudCheckBox T="bool" @bind-Value="@context.IsVisible" Color="Color.Primary" />
                                <MudText>@context.DisplayName</MudText>
                            </MudStack>
                        </MudListItem>
                    }
                    else
                    {
                        <MudListItem T="string" Dense="true" Style="cursor: move; user-select: none;">
                            <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="2" Wrap="Wrap.NoWrap">
                                <MudIcon Icon="@Icons.Material.Filled.DragIndicator" Size="Size.Small" Color="Color.Default" />
                                <MudCheckBox T="bool" @bind-Value="@context.IsVisible" Color="Color.Primary" />
                                <MudText Style="flex-grow:1;">@context.DisplayName</MudText>
                                <MudIconButton Icon="@Icons.Material.Filled.Delete" Size="Size.Small" Color="Color.Error" OnClick="@(() => RemoveCustomColumn(context))" Title="Remove" />
                            </MudStack>
                        </MudListItem>
                    }
                </ItemRenderer>
            </MudDropContainer>

            <MudDivider Class="my-3" />
            <MudText Typo="Typo.subtitle2" Class="mb-2">Add Custom Column</MudText>
            <MudStack Spacing="2">
                <MudTextField @bind-Value="newPropertyKey" Label="Property Key" Placeholder="e.g., NServiceBus.MessageIntent" Variant="Variant.Outlined" Margin="Margin.Dense" />
                <MudTextField @bind-Value="newDisplayName" Label="Display Name" Placeholder="e.g., Message Intent" Variant="Variant.Outlined" Margin="Margin.Dense" />
                <MudButton Variant="Variant.Filled" Color="Color.Primary" OnClick="AddCustomColumn" Disabled="@(string.IsNullOrWhiteSpace(newPropertyKey) || string.IsNullOrWhiteSpace(newDisplayName))" StartIcon="@Icons.Material.Filled.Add">
                    Add Custom Column
                </MudButton>
            </MudStack>
        </MudPaper>
    </DialogContent>
    <DialogActions>
        <MudButton OnClick="ResetToDefault" Color="Color.Warning" Variant="Variant.Text" StartIcon="@Icons.Material.Filled.RestartAlt">Reset to Default</MudButton>
        <MudSpacer />
        <MudButton OnClick="Cancel" Color="Color.Default" Variant="Variant.Text">Cancel</MudButton>
        <MudButton OnClick="Save" Color="Color.Primary" Variant="Variant.Filled" StartIcon="@Icons.Material.Filled.Save">Save</MudButton>
    </DialogActions>
</MudDialog>

@code {
    [CascadingParameter]
    private IMudDialogInstance MudDialog { get; set; } = null!;

    [Parameter]
    public List<ColumnDefinition> Columns { get; set; } = new();

    [Parameter]
    public EventCallback<List<ColumnDefinition>> OnSave { get; set; }

    private string newPropertyKey = string.Empty;
    private string newDisplayName = string.Empty;

    private const string SystemDropZone = "SystemColumns";
    private const string CustomDropZone = "CustomColumns";

    private string GetDropZoneForColumn(ColumnDefinition column)
    {
        return column.IsSystemColumn ? SystemDropZone : CustomDropZone;
    }

    protected override void OnParametersSet()
    {
        base.OnParametersSet();
        // Ensure we have columns - if not provided, load from service
        if (Columns == null || !Columns.Any())
        {
            var config = ColumnConfigService.GetConfiguration();
            Columns = config.Columns.ToList();
        }
    }

    private void OnColumnDropped(MudItemDropInfo<ColumnDefinition> dropItem)
    {
        if (dropItem.Item == null) return;

        // Determine which zone we're working with
        bool isSystemZone = dropItem.DropzoneIdentifier == SystemDropZone;
        
        // Get the list of columns in the target zone
        var zoneColumns = Columns.Where(c => c.IsSystemColumn == isSystemZone).OrderBy(c => c.Order).ToList();
        var oldIndex = zoneColumns.IndexOf(dropItem.Item);
        var newIndex = dropItem.IndexInZone;

        if (oldIndex == newIndex || oldIndex < 0) return;

        // Remove from old position
        zoneColumns.RemoveAt(oldIndex);
        // Insert at new position
        zoneColumns.Insert(newIndex, dropItem.Item);

        // Update Order property for all columns in this zone
        if (isSystemZone)
        {
            // System columns start at 0
            for (int i = 0; i < zoneColumns.Count; i++)
            {
                zoneColumns[i].Order = i;
            }
        }
        else
        {
            // Custom columns start after system columns
            var systemColumnsCount = Columns.Count(c => c.IsSystemColumn);
            for (int i = 0; i < zoneColumns.Count; i++)
            {
                zoneColumns[i].Order = systemColumnsCount + i;
            }
        }

        StateHasChanged();
    }

    private void RemoveCustomColumn(ColumnDefinition column)
    {
        if (!column.IsSystemColumn)
        {
            Columns.Remove(column);
            StateHasChanged();
        }
    }

    private void AddCustomColumn()
    {
        if (string.IsNullOrWhiteSpace(newPropertyKey) || string.IsNullOrWhiteSpace(newDisplayName))
            return;

        var newColumn = new ColumnDefinition
        {
            Id = $"Custom_{newPropertyKey}",
            DisplayName = newDisplayName.Trim(),
            IsVisible = true,
            Type = ColumnType.CustomProperty,
            PropertyKey = newPropertyKey.Trim(),
            Order = Columns.Any() ? Columns.Max(c => c.Order) + 1 : 0,
            IsSystemColumn = false
        };

        // Check if column with same property key already exists
        if (!Columns.Any(c => c.PropertyKey == newColumn.PropertyKey))
        {
            Columns.Add(newColumn);
            newPropertyKey = string.Empty;
            newDisplayName = string.Empty;
            StateHasChanged();
        }
    }

    private async Task ResetToDefault()
    {
        var defaultColumns = ColumnConfigService.GetDefaultColumns();
        Columns.Clear();
        Columns.AddRange(defaultColumns);
        StateHasChanged();
    }

    private async Task Save()
    {
        // Save to the service
        var config = new ColumnConfiguration { Columns = Columns };
        await ColumnConfigService.SaveConfigurationAsync(config);
        
        await OnSave.InvokeAsync(Columns);
        MudDialog?.Close(DialogResult.Ok(true));
    }

    private void Cancel()
    {
        MudDialog?.Cancel();
    }
}
