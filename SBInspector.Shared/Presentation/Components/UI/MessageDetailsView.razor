@using SBInspector.Shared.Core.Domain
@using SBInspector.Shared.Core.Interfaces
@using SBInspector.Shared.Application.Services
@using MudBlazor
@inject IStorageService StorageService

@if (Message != null)
{
    var isNServiceBusMessage = NServiceBusMessageHelper.IsNServiceBusMessage(Message);
    
    <MudCard Class="mud-elevation-2">
        <MudCardHeader>
            <MudText Typo="Typo.h5"><MudIcon Icon="@Icons.Material.Filled.Info" /> Message Details</MudText>
            <MudSpacer />
            @if (isNServiceBusMessage)
            {
                <MudTooltip Text="@(useNServiceBusView ? "Switch to Standard View" : "Switch to NServiceBus View")">
                    <MudSwitch Style="padding-right:0.5rem" Value="useNServiceBusView" ValueChanged="OnUseNServiceBusViewChanged" Color="Color.Primary" Label="NServiceBus View" T="bool" />
                </MudTooltip>
            }
            <MudButton Variant="Variant.Outlined" Color="Color.Secondary" OnClick="HandleBack" StartIcon="@Icons.Material.Filled.ArrowBack">Back to Messages</MudButton>
        </MudCardHeader>
        <MudCardContent>
            @if (isNServiceBusMessage && useNServiceBusView)
            {
                <NServiceBusMessageView Message="@Message" />
                <MessageBodyDisplay MessageBody="@Message.Body" Title="Message Body" />
            }
            else
            {
            <MudGrid>
                <MudItem xs="6">
                    <MudPaper Class="pa-2">
                        <MudText Typo="Typo.subtitle2"><b>Message ID:</b></MudText>
                        <MudText><code>@Message.MessageId</code></MudText>
                    </MudPaper>
                </MudItem>
                <MudItem xs="6">
                    <MudPaper Class="pa-2">
                        <MudText Typo="Typo.subtitle2"><b>Subject:</b></MudText>
                        <MudText>@(string.IsNullOrEmpty(Message.Subject) ? "(no subject)" : Message.Subject)</MudText>
                    </MudPaper>
                </MudItem>
                <MudItem xs="6">
                    <MudPaper Class="pa-2">
                        <MudText Typo="Typo.subtitle2"><b>Content Type:</b></MudText>
                        <MudText>@(string.IsNullOrEmpty(Message.ContentType) ? "(not specified)" : Message.ContentType)</MudText>
                    </MudPaper>
                </MudItem>
                <MudItem xs="6">
                    <MudPaper Class="pa-2">
                        <MudText Typo="Typo.subtitle2"><b>Delivery Count:</b></MudText>
                        <MudChip T="object" Color="@(Message.DeliveryCount > 0 ? Color.Warning : Color.Success)">@Message.DeliveryCount</MudChip>
                    </MudPaper>
                </MudItem>
                <MudItem xs="6">
                    <MudPaper Class="pa-2">
                        <MudText Typo="Typo.subtitle2"><b>Enqueued Time:</b></MudText>
                        <MudText>@Message.EnqueuedTime.ToString("yyyy-MM-dd HH:mm:ss")</MudText>
                    </MudPaper>
                </MudItem>
                @if (Message.ScheduledEnqueueTime.HasValue)
                {
                    <MudItem xs="6">
                        <MudPaper Class="pa-2">
                            <MudText Typo="Typo.subtitle2"><b>Scheduled Enqueue Time:</b></MudText>
                            <MudText>@Message.ScheduledEnqueueTime.Value.ToString("yyyy-MM-dd HH:mm:ss")</MudText>
                        </MudPaper>
                    </MudItem>
                }
                <MudItem xs="12">
                    <MudPaper Class="pa-2">
                        <MudText Typo="Typo.subtitle2"><b>Sequence Number:</b></MudText>
                        <MudText>@Message.SequenceNumber</MudText>
                    </MudPaper>
                </MudItem>
            </MudGrid>
            @if (Message.Properties.Any())
            {
                <MudExpansionPanels Class="mt-3">
                    <MudExpansionPanel Text="@($"Application Properties ({Message.Properties.Count})")" IsInitiallyExpanded="true">
                        <TitleContent>
                            <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="1">
                                <MudIcon Icon="@Icons.Material.Filled.Label" Size="Size.Small" />
                                <MudText Typo="Typo.subtitle2">Application Properties (@Message.Properties.Count)</MudText>
                            </MudStack>
                        </TitleContent>
                        <ChildContent>
                            <MudTable Items="@Message.Properties" Dense="true">
                                <HeaderContent>
                                    <MudTh>Key</MudTh>
                                    <MudTh>Value</MudTh>
                                </HeaderContent>
                                <RowTemplate>
                                    <MudTd><code>@context.Key</code></MudTd>
                                    <MudTd>@context.Value</MudTd>
                                </RowTemplate>
                            </MudTable>
                        </ChildContent>
                    </MudExpansionPanel>
                </MudExpansionPanels>
            }
            <MessageBodyDisplay MessageBody="@Message.Body" Title="Message Body" />
            }
            @if (showSaveTemplateForm)
            {
                <MudCard Class="mt-3">
                    <MudCardContent>
                        <MudText Typo="Typo.subtitle2"><MudIcon Icon="@Icons.Material.Filled.BookmarkAdd" /> Save as Template</MudText>
                        <MudTextField @bind-Value="templateName" Label="Template Name" Required="true" Margin="Margin.Dense" />
                        @if (!string.IsNullOrEmpty(saveMessage))
                        {
                            <MudAlert Severity="Severity.Success" Dense="true">@saveMessage</MudAlert>
                        }
                        @if (!string.IsNullOrEmpty(saveError))
                        {
                            <MudAlert Severity="Severity.Error" Dense="true">@saveError</MudAlert>
                        }
                        <MudStack Direction="Row" Spacing="2">
                            <MudButton Variant="Variant.Filled" Color="Color.Primary" OnClick="SaveAsTemplate" Disabled="@string.IsNullOrWhiteSpace(templateName)"><MudIcon Icon="@Icons.Material.Filled.Save" /> Save</MudButton>
                            <MudButton Variant="Variant.Outlined" Color="Color.Secondary" OnClick="@(() => { showSaveTemplateForm = false; templateName = string.Empty; saveMessage = string.Empty; saveError = string.Empty; })">Cancel</MudButton>
                        </MudStack>
                    </MudCardContent>
                </MudCard>
            }
        </MudCardContent>
        <MudCardActions>
            <MudButton Variant="Variant.Outlined" Color="Color.Secondary" OnClick="HandleBack" StartIcon="@Icons.Material.Filled.ArrowBack">Back to Messages</MudButton>
            @if (!showSaveTemplateForm)
            {
                <MudButton Variant="Variant.Outlined" Color="Color.Primary" OnClick="@(() => showSaveTemplateForm = true)"><MudIcon Icon="@Icons.Material.Filled.BookmarkAdd" /> Save as Template</MudButton>
            }
        </MudCardActions>
    </MudCard>
}

@code {

    [Parameter]
    public MessageInfo? Message { get; set; }

    [Parameter]
    public EventCallback OnBack { get; set; }

    private const int SuccessMessageAutoHideDelayMs = 2000;

    private bool showSaveTemplateForm = false;
    private string templateName = string.Empty;
    private string saveMessage = string.Empty;
    private string saveError = string.Empty;
    private bool useNServiceBusView = false;

    protected override async Task OnInitializedAsync()
    {
        // Load user preference for NServiceBus view
        var preferences = await StorageService.GetUserPreferencesAsync();
        useNServiceBusView = preferences.UseNServiceBusView;
    }

    protected override void OnParametersSet()
    {
        // Reset state when message changes
        showSaveTemplateForm = false;
        templateName = string.Empty;
        saveMessage = string.Empty;
        saveError = string.Empty;
    }
    
    private async Task OnUseNServiceBusViewChanged(bool value)
    {
        useNServiceBusView = value;
        
        // Save preference
        var preferences = new UserPreferences { UseNServiceBusView = value };
        await StorageService.SaveUserPreferencesAsync(preferences);
    }

    private async Task SaveAsTemplate()
    {
        saveMessage = string.Empty;
        saveError = string.Empty;

        if (Message == null || string.IsNullOrWhiteSpace(templateName))
        {
            saveError = "Template name is required.";
            return;
        }

        try
        {
            var template = new MessageTemplate
            {
                Name = templateName.Trim(),
                MessageBody = Message.Body,
                Subject = Message.Subject,
                ContentType = Message.ContentType,
                Properties = Message.Properties?.Count > 0 ? Message.Properties : null
            };

            await StorageService.SaveMessageTemplateAsync(template);
            saveMessage = $"Template '{templateName}' saved successfully!";
            templateName = string.Empty;

            // Auto-hide form after configured delay
            await Task.Delay(SuccessMessageAutoHideDelayMs);
            showSaveTemplateForm = false;
            saveMessage = string.Empty;
        }
        catch (Exception ex)
        {
            saveError = $"Error saving template: {ex.Message}";
        }
    }

    private async Task HandleBack()
    {
        await OnBack.InvokeAsync();
    }
}
