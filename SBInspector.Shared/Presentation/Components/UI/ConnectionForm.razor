@using SBInspector.Shared.Core.Interfaces
@using SBInspector.Shared.Core.Domain
@using SBInspector.Shared.Application.Services
@using MudBlazor
@inject IServiceBusService ServiceBusService
@inject IStorageService StorageService
@inject ConnectionStateService ConnectionState

<MudCard>
    <MudCardContent>
        <MudText Typo="Typo.h5" GutterBottom="true">Connect to Service Bus</MudText>

        <MudTextField Value="@ConnectionString" ValueChanged="@((string val) => OnConnectionStringChanged(val))" Label="Connection String" InputType="InputType.Password" Variant="Variant.Outlined" Margin="Margin.Normal" Placeholder="Endpoint=sb://..." />

        <MudCheckBox T="bool" @bind-Value="shouldSaveConnection" Label="Save this connection for later use" />
        @if (shouldSaveConnection)
        {
            <MudTextField Value="@connectionName" ValueChanged="@((string val) => connectionName = val)" Label="Enter a name for this connection" Variant="Variant.Outlined" Margin="Margin.Dense" />
        }

        @if (!string.IsNullOrEmpty(ErrorMessage))
        {
            <MudAlert Severity="Severity.Error" Elevation="0">@ErrorMessage</MudAlert>
        }

        @if (!string.IsNullOrEmpty(successMessage))
        {
            <MudAlert Severity="Severity.Success" Elevation="0" Dense="true" OnClose="@(() => successMessage = string.Empty)">
                <MudIcon Icon="@Icons.Material.Filled.CheckCircle" /> @successMessage
            </MudAlert>
        }

        <MudButton Variant="Variant.Filled" Color="Color.Primary" Disabled="@IsConnecting" OnClick="HandleConnectAsync">
            @if (IsConnecting)
            {
                <MudProgressCircular Indeterminate="true" Size="Size.Small" />
                <span style="margin-left:8px">Connecting...</span>
            }
            else
            {
                <span>Connect</span>
            }
        </MudButton>
    </MudCardContent>
</MudCard>

@code {
    [Parameter]
    public string ConnectionString { get; set; } = string.Empty;

    [Parameter]
    public EventCallback<string> ConnectionStringChanged { get; set; }

    [Parameter]
    public string ErrorMessage { get; set; } = string.Empty;

    [Parameter]
    public EventCallback<string> ErrorMessageChanged { get; set; }

    [Parameter]
    public bool IsConnecting { get; set; }

    [Parameter]
    public EventCallback<bool> IsConnectingChanged { get; set; }

    [Parameter]
    public EventCallback OnConnected { get; set; }

    private bool shouldSaveConnection = false;
    private string connectionName = string.Empty;
    private string successMessage = string.Empty;

    private async Task HandleConnectAsync()
    {
        await IsConnectingChanged.InvokeAsync(true);
        await ErrorMessageChanged.InvokeAsync(string.Empty);
        successMessage = string.Empty;
        try
        {
            var success = await ServiceBusService.ConnectAsync(ConnectionString);
            if (success)
            {
                // Save connection if requested
                if (shouldSaveConnection && !string.IsNullOrWhiteSpace(connectionName))
                {
                    var savedConnection = new SavedConnection
                    {
                        Name = connectionName.Trim(),
                        ConnectionString = ConnectionString,
                        IsEncrypted = false,
                        LastUsedAt = DateTime.UtcNow
                    };
                    await StorageService.SaveConnectionAsync(savedConnection);
                    successMessage = $"Connection saved as '{connectionName}'";
                    // Notify that connections list has changed
                    ConnectionState.NotifyConnectionsChanged();
                }
                await OnConnected.InvokeAsync();
            }
            else
            {
                await ErrorMessageChanged.InvokeAsync("Failed to connect. Please check your connection string.");
            }
        }
        catch (Exception ex)
        {
            await ErrorMessageChanged.InvokeAsync($"Error: {ex.Message}");
        }
        finally
        {
            await IsConnectingChanged.InvokeAsync(false);
        }
    }
    
    private async Task OnConnectionStringChanged(string value)
    {
        ConnectionString = value;
        await ConnectionStringChanged.InvokeAsync(value);
    }
}