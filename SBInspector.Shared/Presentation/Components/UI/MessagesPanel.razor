@using SBInspector.Shared.Core.Domain
@using SBInspector.Shared.Application.Services
@using MudBlazor
@inject MessageFilterService FilterService

<MudCard Class="mud-elevation-1 mt-2">
    <MudCardHeader Class="py-2">
        <CardHeaderContent>
            <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="2" Wrap="Wrap.Wrap">
                <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="1">
                    <MudIcon Icon="@Icons.Material.Filled.MarkEmailRead" Size="Size.Medium" />
                    <MudText Typo="Typo.h6">@EntityName</MudText>
                    <MudChip T="string" Color="@(GetMessageTypeBadgeColor())" Size="Size.Small">@MessageType</MudChip>
                </MudStack>
                <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="1" Wrap="Wrap.Wrap" Class="ml-auto">
                    <MudIconButton Icon="@Icons.Material.Filled.Refresh" Color="Color.Primary" OnClick="HandleRefresh" Size="Size.Small" Title="Refresh" />
                    <MudIconButton Icon="@Icons.Material.Filled.Add" Color="Color.Success" OnClick="HandleSendNew" Size="Size.Small" Title="Send New" />
                    <MudIconButton Icon="@Icons.Material.Filled.Download" Color="Color.Info" OnClick="HandleExportFiltered" Size="Size.Small" Title="Export Filtered" />
                    <MudIconButton Icon="@Icons.Material.Filled.Delete" Color="Color.Warning" OnClick="HandleDeleteFiltered" Size="Size.Small" Title="Delete Filtered" />
                    <MudIconButton Icon="@Icons.Material.Filled.DeleteForever" Color="Color.Error" OnClick="HandlePurge" Size="Size.Small" Title="Purge All" />
                    <MudSelect T="int" Value="@PageSize" ValueChanged="@OnPageSizeChanged" Dense="true" Margin="Margin.Dense" Variant="Variant.Outlined" Style="width:80px;" Label="Page">
                        <MudSelectItem Value="50">50</MudSelectItem>
                        <MudSelectItem Value="100">100</MudSelectItem>
                        <MudSelectItem Value="200">200</MudSelectItem>
                        <MudSelectItem Value="500">500</MudSelectItem>
                    </MudSelect>
                    <MudIconButton Icon="@Icons.Material.Filled.Close" Color="Color.Default" OnClick="HandleClose" Size="Size.Small" Title="Close" />
                </MudStack>
            </MudStack>
        </CardHeaderContent>
    </MudCardHeader>
    <MudCardContent>
        @if (IsLoading)
        {
            <MudStack AlignItems="AlignItems.Center" Spacing="2" Class="my-4">
                <MudProgressCircular Color="Color.Primary" Size="Size.Large" />
                <MudText Typo="Typo.body1">Loading messages...</MudText>
            </MudStack>
        }
        else if (SelectedMessage != null)
        {
            <MessageDetailsView Message="@SelectedMessage" OnBack="@HandleBackToList" />
        }
        else if (Messages.Any())
        {
            <MudStack Row="true" Spacing="2" Class="mb-2" AlignItems="AlignItems.Center">
                <MudChip T="string" Icon="@Icons.Material.Filled.Dns" Color="Color.Info" Size="Size.Small">Total: @Messages.Count</MudChip>
                <MudChip T="string" Icon="@Icons.Material.Filled.FilterList" Color="Color.Primary" Size="Size.Small">Filtered: @FilteredMessages.Count()</MudChip>
            </MudStack>

            <MessageFilterPanel Filters="@Filters" FiltersChanged="@FiltersChanged" FilteredCount="@FilteredMessages.Count()" TotalCount="@Messages.Count" />

            <MessageListTable Messages="@FilteredMessages" SortColumn="@SortColumn" SortColumnChanged="@SortColumnChanged" SortAscending="@SortAscending" SortAscendingChanged="@SortAscendingChanged" OnViewDetails="@HandleViewDetails" OnExport="@OnExportMessage" OnDelete="@OnDeleteMessage" OnRequeue="@OnRequeueMessage" OnMoveToDeadLetter="@OnMoveToDeadLetterMessage" OnReschedule="@OnRescheduleMessage" />

            @if (HasMoreMessages)
            {
                <MudStack AlignItems="AlignItems.Center" Class="mt-3">
                    <MudButton Variant="Variant.Filled" Color="Color.Primary" OnClick="HandleLoadMore" Disabled="@IsLoadingMore" StartIcon="@Icons.Material.Filled.KeyboardArrowDown">
                        @if (IsLoadingMore)
                        {
                            <MudProgressCircular Indeterminate="true" Size="Size.Small" Class="mr-2" />
                            <span>Loading more messages...</span>
                        }
                        else
                        {
                            <span>Load More Messages</span>
                        }
                    </MudButton>
                </MudStack>
            }
            else if (Messages.Count >= PageSize)
            {
                <MudStack AlignItems="AlignItems.Center" Class="mt-3">
                    <MudText Color="Color.Success"><MudIcon Icon="@Icons.Material.Filled.CheckCircle" /> All available messages loaded</MudText>
                </MudStack>
            }
        }
        else
        {
            <MudAlert Severity="Severity.Info"><MudIcon Icon="@Icons.Material.Filled.Info" /> No messages found in this queue/subscription.</MudAlert>
        }
    </MudCardContent>
</MudCard>

@code {
    [Parameter]
    public string EntityName { get; set; } = string.Empty;

    [Parameter]
    public string MessageType { get; set; } = string.Empty;

    [Parameter]
    public List<MessageInfo> Messages { get; set; } = new();

    [Parameter]
    public bool IsLoading { get; set; }

    [Parameter]
    public List<MessageFilter> Filters { get; set; } = new();

    [Parameter]
    public EventCallback<List<MessageFilter>> FiltersChanged { get; set; }

    [Parameter]
    public string SortColumn { get; set; } = nameof(MessageInfo.EnqueuedTime);

    [Parameter]
    public EventCallback<string> SortColumnChanged { get; set; }

    [Parameter]
    public bool SortAscending { get; set; } = false;

    [Parameter]
    public EventCallback<bool> SortAscendingChanged { get; set; }

    [Parameter]
    public int PageSize { get; set; } =100;

    [Parameter]
    public EventCallback<int> PageSizeChanged { get; set; }

    [Parameter]
    public bool HasMoreMessages { get; set; }

    [Parameter]
    public bool IsLoadingMore { get; set; }

    [Parameter]
    public EventCallback OnClose { get; set; }

    [Parameter]
    public EventCallback<MessageInfo> OnExportMessage { get; set; }

    [Parameter]
    public EventCallback<MessageInfo> OnDeleteMessage { get; set; }

    [Parameter]
    public EventCallback<MessageInfo> OnRequeueMessage { get; set; }

    [Parameter]
    public EventCallback<MessageInfo> OnMoveToDeadLetterMessage { get; set; }

    [Parameter]
    public EventCallback<MessageInfo> OnRescheduleMessage { get; set; }

    [Parameter]
    public EventCallback OnLoadMore { get; set; }

    [Parameter]
    public EventCallback OnSendNew { get; set; }

    [Parameter]
    public EventCallback OnPurge { get; set; }

    [Parameter]
    public EventCallback OnDeleteFiltered { get; set; }

    [Parameter]
    public EventCallback OnExportFiltered { get; set; }

    [Parameter]
    public EventCallback OnRefresh { get; set; }

    private MessageInfo? SelectedMessage { get; set; }

    private IEnumerable<MessageInfo> FilteredMessages => FilterService.ApplyFilters(Messages, Filters);

    private async Task HandleClose()
    {
        await OnClose.InvokeAsync();
    }

    private async Task HandleLoadMore()
    {
        await OnLoadMore.InvokeAsync();
    }

    private async Task HandleSendNew()
    {
        await OnSendNew.InvokeAsync();
    }

    private async Task HandlePurge()
    {
        await OnPurge.InvokeAsync();
    }

    private async Task HandleDeleteFiltered()
    {
        await OnDeleteFiltered.InvokeAsync();
    }

    private async Task HandleExportFiltered()
    {
        await OnExportFiltered.InvokeAsync();
    }

    private async Task HandleRefresh()
    {
        await OnRefresh.InvokeAsync();
    }

    private void HandleViewDetails(MessageInfo message)
    {
        SelectedMessage = message;
        StateHasChanged();
    }

    private void HandleBackToList()
    {
        SelectedMessage = null;
        StateHasChanged();
    }

    private async Task OnPageSizeChanged(int newSize)
    {
        PageSize = newSize;
        await PageSizeChanged.InvokeAsync(newSize);
    }

    private Color GetMessageTypeBadgeColor()
    {
        return MessageType.ToLower() switch
        {
            "active" => Color.Primary,
            "scheduled" => Color.Warning,
            "deadletter" => Color.Error,
            _ => Color.Secondary
        };
    }
}
