@using SBInspector.Shared.Core.Domain

<div class="table-responsive scrollable-content">
    <table class="table table-sm table-enhanced">
        <thead>
            <tr>
                <th @onclick="() => HandleSortColumn(nameof(MessageInfo.MessageId))" class="sortable-header">
                    Message ID @GetSortIcon(nameof(MessageInfo.MessageId))
                </th>
                <th @onclick="() => HandleSortColumn(nameof(MessageInfo.Subject))" class="sortable-header">
                    Subject @GetSortIcon(nameof(MessageInfo.Subject))
                </th>
                <th @onclick="() => HandleSortColumn(nameof(MessageInfo.EnqueuedTime))" class="sortable-header">
                    Enqueued Time @GetSortIcon(nameof(MessageInfo.EnqueuedTime))
                </th>
                <th @onclick="() => HandleSortColumn(nameof(MessageInfo.DeliveryCount))" class="sortable-header text-center">
                    Delivery @GetSortIcon(nameof(MessageInfo.DeliveryCount))
                </th>
                <th class="text-center" style="min-width: 200px;">Actions</th>
            </tr>
        </thead>
        <tbody>
            @foreach (var message in SortedMessages)
            {
                <tr @onclick="() => OnViewDetails.InvokeAsync(message)" style="cursor: pointer;" title="Click to view details">
                    <td>
                        <code class="text-truncate d-inline-block" style="max-width: 200px;" title="@message.MessageId">
                            @message.MessageId
                        </code>
                    </td>
                    <td>
                        <span class="text-truncate d-inline-block" style="max-width: 300px;" title="@message.Subject">
                            @(string.IsNullOrEmpty(message.Subject) ? "(no subject)" : message.Subject)
                        </span>
                    </td>
                    <td>
                        <span class="text-nowrap">@message.EnqueuedTime.ToString("yyyy-MM-dd HH:mm:ss")</span>
                    </td>
                    <td class="text-center">
                        <span class="badge @(message.DeliveryCount > 0 ? "bg-warning text-dark" : "bg-secondary")">
                            @message.DeliveryCount
                        </span>
                    </td>
                    <td class="text-center">
                        <div class="btn-group btn-group-sm" role="group">
                            <button class="btn btn-info" @onclick="() => OnViewDetails.InvokeAsync(message)" @onclick:stopPropagation="true" title="View message details">
                                <i class="bi bi-eye"></i>
                            </button>
                            <button class="btn btn-secondary" @onclick="() => OnExport.InvokeAsync(message)" @onclick:stopPropagation="true" title="Export this message">
                                <i class="bi bi-download"></i>
                            </button>
                            @if (message.State == "DeadLetter")
                            {
                                <button class="btn btn-success" @onclick="() => OnRequeue.InvokeAsync(message)" @onclick:stopPropagation="true" title="Requeue message to active queue">
                                    <i class="bi bi-arrow-counterclockwise"></i>
                                </button>
                            }
                            @if (message.State == "Scheduled" && message.ScheduledEnqueueTime.HasValue)
                            {
                                <button class="btn btn-warning" @onclick="() => OnReschedule.InvokeAsync(message)" @onclick:stopPropagation="true" title="Reschedule message">
                                    <i class="bi bi-clock-history"></i>
                                </button>
                            }
                            <button class="btn btn-danger" @onclick="() => OnDelete.InvokeAsync(message)" @onclick:stopPropagation="true" title="Delete message">
                                <i class="bi bi-trash"></i>
                            </button>
                        </div>
                    </td>
                </tr>
            }
        </tbody>
    </table>
</div>

@if (!Messages.Any())
{
    <div class="alert alert-info mt-3">
        <i class="bi bi-info-circle"></i> No messages match the current filter criteria.
    </div>
}

@code {
    [Parameter]
    public IEnumerable<MessageInfo> Messages { get; set; } = Enumerable.Empty<MessageInfo>();

    [Parameter]
    public string SortColumn { get; set; } = nameof(MessageInfo.EnqueuedTime);

    [Parameter]
    public EventCallback<string> SortColumnChanged { get; set; }

    [Parameter]
    public bool SortAscending { get; set; } = false;

    [Parameter]
    public EventCallback<bool> SortAscendingChanged { get; set; }

    [Parameter]
    public EventCallback<MessageInfo> OnViewDetails { get; set; }

    [Parameter]
    public EventCallback<MessageInfo> OnExport { get; set; }

    [Parameter]
    public EventCallback<MessageInfo> OnDelete { get; set; }

    [Parameter]
    public EventCallback<MessageInfo> OnRequeue { get; set; }

    [Parameter]
    public EventCallback<MessageInfo> OnReschedule { get; set; }

    private IEnumerable<MessageInfo> SortedMessages
    {
        get
        {
            var sorted = SortColumn switch
            {
                nameof(MessageInfo.MessageId) => SortAscending 
                    ? Messages.OrderBy(m => m.MessageId) 
                    : Messages.OrderByDescending(m => m.MessageId),
                nameof(MessageInfo.Subject) => SortAscending 
                    ? Messages.OrderBy(m => m.Subject) 
                    : Messages.OrderByDescending(m => m.Subject),
                nameof(MessageInfo.EnqueuedTime) => SortAscending 
                    ? Messages.OrderBy(m => m.EnqueuedTime) 
                    : Messages.OrderByDescending(m => m.EnqueuedTime),
                nameof(MessageInfo.DeliveryCount) => SortAscending 
                    ? Messages.OrderBy(m => m.DeliveryCount) 
                    : Messages.OrderByDescending(m => m.DeliveryCount),
                _ => Messages
            };
            
            return sorted;
        }
    }

    private string GetSortIcon(string columnName)
    {
        if (SortColumn != columnName)
        {
            return "⇅";
        }
        
        return SortAscending ? "▲" : "▼";
    }

    private async Task HandleSortColumn(string columnName)
    {
        if (SortColumn == columnName)
        {
            await SortAscendingChanged.InvokeAsync(!SortAscending);
        }
        else
        {
            await SortColumnChanged.InvokeAsync(columnName);
            // Default to descending for EnqueuedTime, ascending for others
            await SortAscendingChanged.InvokeAsync(columnName != nameof(MessageInfo.EnqueuedTime));
        }
    }
}
