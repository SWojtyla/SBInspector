@using SBInspector.Shared.Core.Domain
@using MudBlazor

<MudPaper Class="pa-2 mud-elevation-2">
    <MudStack Spacing="2">
        <MudStack Direction="Row" AlignItems="AlignItems.Center" JustifyContent="SpaceBetween">
            <MudText Typo="Typo.h5"><MudIcon Icon="@Icons.Material.Filled.AccountTree" /> Service Bus Entities</MudText>
            <MudButton Variant="Variant.Filled" Color="Color.Primary" OnClick="HandleRefresh" Disabled="@IsLoading" StartIcon="@Icons.Material.Filled.Refresh">Refresh</MudButton>
        </MudStack>
        @if (IsLoading)
        {
            <MudStack AlignItems="AlignItems.Center" Class="py-2">
                <MudProgressCircular Color="Color.Primary" Size="Size.Small" />
                <MudText Typo="Typo.body2">Loading...</MudText>
            </MudStack>
        }
        @if (!IsLoading && (Queues.Any() || Topics.Any()))
        {
            <MudTextField @bind-Value="searchTerm" Placeholder="Search queues and topics..." Adornment="Adornment.Start" AdornmentIcon="@Icons.Material.Filled.Search" Margin="Margin.Dense" Class="mb-2" />
            @if (!string.IsNullOrWhiteSpace(searchTerm))
            {
                <MudIconButton Icon="@Icons.Material.Filled.Clear" Color="Color.Default" OnClick="ClearSearch" Title="Clear search" />
            }
        }
        <MudStack Spacing="2">
            @if (FilteredQueues.Any())
            {
                <MudExpansionPanels>
                    <MudExpansionPanel Text=$"Queues ({FilteredQueues.Count()})">
                        <MudList T=EntityInfo Dense="true">
                            @foreach (var queue in FilteredQueues)
                            {
                                <MudListItem Class="@((IsSelected("queue", queue.Name) ? "mud-selected" : string.Empty))" Style="cursor:pointer;" @onclick="() => SelectQueue(queue.Name)">
                                    <MudIcon Icon="@Icons.Material.Filled.Inbox" />
                                    <MudText Class="ml-2">@queue.Name</MudText>
                                    <MudChip Color="@(GetStatusColor(queue.Status))" Size="Size.Small" Class="ml-2">@queue.Status</MudChip>
                                    @if (queue.ActiveMessageCount > 0)
                                    {
                                        <MudChip Color="Color.Primary" Size="Size.Small" Class="ml-1">@queue.ActiveMessageCount</MudChip>
                                    }
                                    @if (queue.ScheduledMessageCount > 0)
                                    {
                                        <MudChip Color="Color.Warning" Size="Size.Small" Class="ml-1">@queue.ScheduledMessageCount</MudChip>
                                    }
                                    @if (queue.DeadLetterMessageCount > 0)
                                    {
                                        <MudChip Color="Color.Error" Size="Size.Small" Class="ml-1">@queue.DeadLetterMessageCount</MudChip>
                                    }
                                </MudListItem>
                            }
                        </MudList>
                    </MudExpansionPanel>
                </MudExpansionPanels>
            }
            @if (FilteredTopics.Any())
            {
                <MudExpansionPanels>
                    <MudExpansionPanel Text=$"Topics ({FilteredTopics.Count()})">
                        <MudList T=EntityInfo Dense="true">
                            @foreach (var topic in FilteredTopics)
                            {
                                <MudListItem Class="@((IsSelected("topic", topic.Name) ? "mud-selected" : string.Empty))" Style="cursor:pointer;" @onclick="() => SelectTopic(topic.Name)">
                                    <MudIcon Icon="@Icons.Material.Filled.Campaign" />
                                    <MudText Class="ml-2">@topic.Name</MudText>
                                    <MudChip Color="@(GetStatusColor(topic.Status))" Size="Size.Small" Class="ml-2">@topic.Status</MudChip>
                                    <MudIconButton Icon="@(expandedTopics.Contains(topic.Name) ? Icons.Material.Filled.ExpandLess : Icons.Material.Filled.ExpandMore)" Color="Color.Default" OnClick="@(() => ToggleTopic(topic.Name))" />
                                </MudListItem>

                                @if (expandedTopics.Contains(topic.Name) && TopicSubscriptions.ContainsKey(topic.Name))
                                {
                                    <MudList Dense="true" Class="ml-4">
                                        @if (LoadingTopics.Contains(topic.Name))
                                        {
                                            <MudProgressCircular Color="Color.Primary" Size="Size.Small" />
                                        }
                                        else
                                        {
                                            @foreach (var subscription in FilteredSubscriptions(topic.Name))
                                            {
                                                <MudListItem Class="@((IsSelected("subscription", $"{topic.Name}/{subscription.Name}") ? "mud-selected" : string.Empty))" Style="cursor:pointer;" @onclick="() => SelectSubscription(topic.Name, subscription.Name)">
                                                    <MudIcon Icon="@Icons.Material.Filled.Email" />
                                                    <MudText Class="ml-2">@subscription.Name</MudText>
                                                    <MudChip Color="@(GetStatusColor(subscription.Status))" Size="Size.Small" Class="ml-2">@subscription.Status</MudChip>
                                                    @if (subscription.ActiveMessageCount > 0)
                                                    {
                                                        <MudChip Color="Color.Primary" Size="Size.Small" Class="ml-1">@subscription.ActiveMessageCount</MudChip>
                                                    }
                                                    @if (subscription.DeadLetterMessageCount > 0)
                                                    {
                                                        <MudChip Color="Color.Error" Size="Size.Small" Class="ml-1">@subscription.DeadLetterMessageCount</MudChip>
                                                    }
                                                </MudListItem>
                                            }
                                        }
                                    </MudList>
                                }
                            }
                        </MudList>
                    </MudExpansionPanel>
                </MudExpansionPanels>
            }

            @if (!FilteredQueues.Any() && !FilteredTopics.Any() && (Queues.Any() || Topics.Any()))
            {
                <MudAlert Severity="Severity.Info">No entities match your search criteria.</MudAlert>
            }
            @if (!Queues.Any() && !Topics.Any())
            {
                <MudAlert Severity="Severity.Info">No entities found</MudAlert>
            }
        </MudStack>
    </MudStack>
</MudPaper>

@code {
    [Parameter] public List<EntityInfo> Queues { get; set; } = new();
    [Parameter] public List<EntityInfo> Topics { get; set; } = new();
    [Parameter] public Dictionary<string, List<SubscriptionInfo>> TopicSubscriptions { get; set; } = new();
    [Parameter] public HashSet<string> LoadingTopics { get; set; } = new();
    [Parameter] public bool IsLoading { get; set; }
    [Parameter] public string? SelectedEntityType { get; set; }
    [Parameter] public string? SelectedEntityName { get; set; }
    [Parameter] public EventCallback<string> OnQueueSelected { get; set; }
    [Parameter] public EventCallback<string> OnTopicSelected { get; set; }
    [Parameter] public EventCallback<(string TopicName, string SubscriptionName)> OnSubscriptionSelected { get; set; }
    [Parameter] public EventCallback<string> OnLoadSubscriptions { get; set; }
    [Parameter] public EventCallback OnRefresh { get; set; }

    private HashSet<string> expandedTopics = new();
    private string searchTerm = string.Empty;

    private IEnumerable<EntityInfo> FilteredQueues => string.IsNullOrWhiteSpace(searchTerm)
    ? Queues
    : Queues.Where(q => q.Name.Contains(searchTerm, StringComparison.OrdinalIgnoreCase));

    private IEnumerable<EntityInfo> FilteredTopics => string.IsNullOrWhiteSpace(searchTerm)
    ? Topics
    : Topics.Where(t => t.Name.Contains(searchTerm, StringComparison.OrdinalIgnoreCase));

    private IEnumerable<SubscriptionInfo> FilteredSubscriptions(string topicName)
    {
        if (!TopicSubscriptions.ContainsKey(topicName)) return Enumerable.Empty<SubscriptionInfo>();
        var subs = TopicSubscriptions[topicName];
        return string.IsNullOrWhiteSpace(searchTerm)
        ? subs
        : subs.Where(s => s.Name.Contains(searchTerm, StringComparison.OrdinalIgnoreCase));
    }

    private void ClearSearch() => searchTerm = string.Empty;

    private async Task HandleRefresh() => await OnRefresh.InvokeAsync();

    private async Task SelectQueue(string queueName) => await OnQueueSelected.InvokeAsync(queueName);
    private async Task SelectTopic(string topicName) => await OnTopicSelected.InvokeAsync(topicName);
    private async Task SelectSubscription(string topicName, string subscriptionName) => await OnSubscriptionSelected.InvokeAsync((topicName, subscriptionName));

    private void ToggleTopic(string topicName)
    {
        if (expandedTopics.Contains(topicName))
        {
            expandedTopics.Remove(topicName);
        }
        else
        {
            expandedTopics.Add(topicName);
            if (!TopicSubscriptions.ContainsKey(topicName))
            {
                _ = OnLoadSubscriptions.InvokeAsync(topicName); // fire and forget
            }
        }
    }

    private bool IsSelected(string entityType, string entityName) => SelectedEntityType == entityType && SelectedEntityName == entityName;

    private Color GetStatusColor(string status) => status == "Active" ? Color.Success : Color.Default;
}
