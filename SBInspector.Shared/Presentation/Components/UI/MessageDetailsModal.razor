@using SBInspector.Shared.Core.Domain
@using SBInspector.Shared.Core.Interfaces
@using MudBlazor
@inject IStorageService StorageService

@if (Message != null)
{
    <MudDialog MaxWidth="MaxWidth.Large" FullWidth="true" Open="true">
        <MudDialogTitle>
            <MudIcon Icon="@Icons.Material.Filled.Info" Class="me-2" /> Message Details
        </MudDialogTitle>
        <MudDialogContent>
            <MudGrid>
                <MudItem xs="6">
                    <MudText Typo="Typo.subtitle2"><b>Message ID:</b></MudText>
                    <MudText><code>@Message.MessageId</code></MudText>
                </MudItem>
                <MudItem xs="6">
                    <MudText Typo="Typo.subtitle2"><b>Subject:</b></MudText>
                    <MudText>@(string.IsNullOrEmpty(Message.Subject) ? "(no subject)" : Message.Subject)</MudText>
                </MudItem>
                <MudItem xs="6">
                    <MudText Typo="Typo.subtitle2"><b>Content Type:</b></MudText>
                    <MudText>@(string.IsNullOrEmpty(Message.ContentType) ? "(not specified)" : Message.ContentType)</MudText>
                </MudItem>
                <MudItem xs="6">
                    <MudText Typo="Typo.subtitle2"><b>Delivery Count:</b></MudText>
                    <MudChip T="object" Color="@(Message.DeliveryCount > 0 ? Color.Warning : Color.Success)">@Message.DeliveryCount</MudChip>
                </MudItem>
                <MudItem xs="6">
                    <MudText Typo="Typo.subtitle2"><b>Enqueued Time:</b></MudText>
                    <MudText>@Message.EnqueuedTime.ToString("yyyy-MM-dd HH:mm:ss")</MudText>
                </MudItem>
                @if (Message.ScheduledEnqueueTime.HasValue)
                {
                    <MudItem xs="6">
                        <MudText Typo="Typo.subtitle2"><b>Scheduled Enqueue Time:</b></MudText>
                        <MudText>@Message.ScheduledEnqueueTime.Value.ToString("yyyy-MM-dd HH:mm:ss")</MudText>
                    </MudItem>
                }
                <MudItem xs="12">
                    <MudText Typo="Typo.subtitle2"><b>Sequence Number:</b></MudText>
                    <MudText>@Message.SequenceNumber</MudText>
                </MudItem>
            </MudGrid>
            @if (Message.Properties.Any())
            {
                <MudText Typo="Typo.subtitle2" Class="mt-3"><MudIcon Icon="@Icons.Material.Filled.Label" /> Application Properties (@Message.Properties.Count)</MudText>
                <MudTable Items="@Message.Properties" Dense="true">
                    <HeaderContent>
                        <MudTh>Key</MudTh>
                        <MudTh>Value</MudTh>
                    </HeaderContent>
                    <RowTemplate>
                        <MudTd><code>@context.Key</code></MudTd>
                        <MudTd>@context.Value</MudTd>
                    </RowTemplate>
                </MudTable>
            }
            <MudText Typo="Typo.subtitle2" Class="mt-3"><MudIcon Icon="@Icons.Material.Filled.Description" /> Message Body</MudText>
            <MudPaper Class="pa-2" Style="max-height:300px;overflow-y:auto;font-size:0.85rem;">
    <pre>@Message.Body</pre>
            </MudPaper>
            @if (showSaveTemplateForm)
            {
                <MudCard Class="mt-3">
                    <MudCardContent>
                        <MudText Typo="Typo.subtitle2"><MudIcon Icon="@Icons.Material.Filled.BookmarkAdd" /> Save as Template</MudText>
                        <MudTextField @bind-Value="templateName" Label="Template Name" Required="true" Margin="Margin.Dense" />
                        @if (!string.IsNullOrEmpty(saveMessage))
                        {
                            <MudAlert Severity="Severity.Success" Dense="true">@saveMessage</MudAlert>
                        }
                        @if (!string.IsNullOrEmpty(saveError))
                        {
                            <MudAlert Severity="Severity.Error" Dense="true">@saveError</MudAlert>
                        }
                        <MudStack Direction="Row" Spacing="2">
                            <MudButton Variant="Variant.Filled" Color="Color.Primary" OnClick="SaveAsTemplate" Disabled="@string.IsNullOrWhiteSpace(templateName)"><MudIcon Icon="@Icons.Material.Filled.Save" /> Save</MudButton>
                            <MudButton Variant="Variant.Outlined" Color="Color.Secondary" OnClick="@(() => { showSaveTemplateForm = false; templateName = string.Empty; saveMessage = string.Empty; saveError = string.Empty; })">Cancel</MudButton>
                        </MudStack>
                    </MudCardContent>
                </MudCard>
            }
        </MudDialogContent>
        <MudDialogActions>
            @if (!showSaveTemplateForm)
            {
                <MudButton Variant="Variant.Outlined" Color="Color.Primary" OnClick="@(() => showSaveTemplateForm = true)"><MudIcon Icon="@Icons.Material.Filled.BookmarkAdd" /> Save as Template</MudButton>
            }
            <MudButton Variant="Variant.Text" Color="Color.Secondary" OnClick="HandleClose"><MudIcon Icon="@Icons.Material.Filled.Close" /> Close</MudButton>
        </MudDialogActions>
    </MudDialog>
}

@code {
    [Parameter]
    public MessageInfo? Message { get; set; }

    [Parameter]
    public EventCallback OnClose { get; set; }

    private bool showSaveTemplateForm = false;
    private string templateName = string.Empty;
    private string saveMessage = string.Empty;
    private string saveError = string.Empty;

    protected override void OnParametersSet()
    {
        // Reset state when message changes
        showSaveTemplateForm = false;
        templateName = string.Empty;
        saveMessage = string.Empty;
        saveError = string.Empty;
    }

    private async Task SaveAsTemplate()
    {
        saveMessage = string.Empty;
        saveError = string.Empty;

        if (Message == null || string.IsNullOrWhiteSpace(templateName))
        {
            saveError = "Template name is required.";
            return;
        }

        try
        {
            var template = new MessageTemplate
            {
                Name = templateName.Trim(),
                MessageBody = Message.Body,
                Subject = Message.Subject,
                ContentType = Message.ContentType,
                Properties = Message.Properties?.Count > 0 ? Message.Properties : null
            };

            await StorageService.SaveMessageTemplateAsync(template);
            saveMessage = $"Template '{templateName}' saved successfully!";
            templateName = string.Empty;

            // Auto-hide form after 2 seconds
            await Task.Delay(2000);
            showSaveTemplateForm = false;
            saveMessage = string.Empty;
        }
        catch (Exception ex)
        {
            saveError = $"Error saving template: {ex.Message}";
        }
    }

    private async Task HandleClose()
    {
        await OnClose.InvokeAsync();
    }
}
