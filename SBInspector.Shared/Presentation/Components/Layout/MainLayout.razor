@using SBInspector.Shared.Core.Domain
@using SBInspector.Shared.Core.Interfaces
@using SBInspector.Shared.Application.Services
@inject IServiceBusService ServiceBusService
@inject IStorageService StorageService
@inject ConnectionStateService ConnectionState
@inject ConnectionStringEncryptionService EncryptionService
@inherits LayoutComponentBase

<MudThemeProvider />
<MudDialogProvider />
<MudSnackbarProvider />

<div class="page">
    <div class="sidebar">
        <NavMenu 
            OnConnectionSelected="@HandleConnectionSelected"
            OnDisconnectRequested="@HandleDisconnectRequested"
            @ref="navMenuRef" />
    </div>

    <main>
        <div class="top-row px-4">
            <a href="https://learn.microsoft.com/aspnet/core/" target="_blank">About</a>
        </div>

        <article class="content px-4">
            @Body
        </article>
    </main>
</div>

<div id="blazor-error-ui" data-nosnippet>
    An unhandled error has occurred.
    <a href="." class="reload">Reload</a>
    <span class="dismiss">ðŸ—™</span>
</div>

@code {
    private NavMenu? navMenuRef;

    private async Task HandleConnectionSelected(SavedConnection connection)
    {
        try
        {
            // First disconnect from current connection if connected
            if (ServiceBusService.IsConnected)
            {
                await ServiceBusService.DisconnectAsync();
                // Small delay for smoother transition
                await Task.Delay(100);
            }
            
            // Decrypt connection string if encrypted
            var connectionString = connection.IsEncrypted 
                ? EncryptionService.Decrypt(connection.ConnectionString)
                : connection.ConnectionString;
            
            var success = await ServiceBusService.ConnectAsync(connectionString);
            if (success)
            {
                ConnectionState.CurrentConnectionString = connectionString;
                
                // Update last used time
                await StorageService.UpdateLastUsedAsync(connection.Name);
                
                // Refresh the connections list to show updated timestamps
                if (navMenuRef != null)
                {
                    await navMenuRef.RefreshConnectionsAsync();
                }
            }
        }
        catch (Exception)
        {
            // Error handling can be improved with notifications if needed
        }
    }

    private async Task HandleDisconnectRequested()
    {
        await ServiceBusService.DisconnectAsync();
        ConnectionState.CurrentConnectionString = null;
    }
}
